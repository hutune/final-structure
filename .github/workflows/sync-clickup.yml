name: Sync BMAD Artifacts to ClickUp

on:
  push:
    branches: [main]
    paths:
      - '_bmad-output/epics/**/*.md'
      - '_bmad-output/stories/**/*.md'

env:
  CLICKUP_EPICS_LIST_ID: "901815396322"
  CLICKUP_STORIES_LIST_ID: "901815396340"
  # Email to ClickUp User ID mapping
  EMAIL_TO_CLICKUP_ID: "work.huutrung@gmail.com:300697285,mazhnguyen@kwayvina.com:300697285"

permissions:
  contents: write

jobs:
  sync-to-clickup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Changed Files and Commit Author
        id: changed
        run: |
          CHANGED=$(git diff --name-only HEAD^ HEAD 2>/dev/null | grep -E '_bmad-output/(epics|stories)/.*\.md$' | tr '\n' ' ' || echo "")
          AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
          echo "files=$CHANGED" >> $GITHUB_OUTPUT
          echo "author_email=$AUTHOR_EMAIL" >> $GITHUB_OUTPUT
          echo "Found: $CHANGED | Author: $AUTHOR_EMAIL"

      - name: Sync to ClickUp
        if: steps.changed.outputs.files != ''
        env:
          CLICKUP_API_KEY: ${{ secrets.CLICKUP_API_KEY }}
          EPICS_LIST: ${{ env.CLICKUP_EPICS_LIST_ID }}
          STORIES_LIST: ${{ env.CLICKUP_STORIES_LIST_ID }}
          EMAIL_MAP: ${{ env.EMAIL_TO_CLICKUP_ID }}
          COMMIT_AUTHOR: ${{ steps.changed.outputs.author_email }}
        run: |
          echo "Starting sync..."
          
          # Helper: Get ClickUp user ID from email
          get_user_id() {
            echo "$EMAIL_MAP" | tr ',' '\n' | grep "^$1:" | cut -d':' -f2
          }
          
          # Helper: Convert date string (YYYY-MM-DD) to Unix milliseconds
          date_to_ms() {
            if [ -n "$1" ] && [ "$1" != "null" ]; then
              date -d "$1" +%s000 2>/dev/null || echo ""
            fi
          }
          
          # Helper: Convert hours to milliseconds
          hours_to_ms() {
            if [ -n "$1" ] && [ "$1" != "null" ]; then
              echo $(( $1 * 3600000 ))
            fi
          }
          
          # Helper: Map priority string to ClickUp priority number
          priority_to_num() {
            case "$1" in
              urgent) echo 1;;
              high) echo 2;;
              normal) echo 3;;
              low) echo 4;;
              *) echo "";;
            esac
          }
          
          # First pass: Create/Update all tasks and collect epic_id -> clickup_id mapping
          declare -A EPIC_CU_MAP
          
          # Load existing epic mappings from repo
          for epic_file in _bmad-output/epics/*.md 2>/dev/null; do
            [ -f "$epic_file" ] || continue
            FM=$(sed -n '2,/^---$/p' "$epic_file" | head -n -1)
            E_ID=$(echo "$FM" | grep "^id:" | sed 's/^id: *//' | sed 's/^"//;s/"$//' | tr -d '\r')
            E_CU=$(echo "$FM" | grep "^clickup_task_id:" | sed 's/^clickup_task_id: *//' | sed 's/^"//;s/"$//;s/^null$//' | tr -d '\r')
            [ -n "$E_ID" ] && [ -n "$E_CU" ] && EPIC_CU_MAP["$E_ID"]="$E_CU"
          done
          echo "Loaded ${#EPIC_CU_MAP[@]} epic mappings"
          
          for file in ${{ steps.changed.outputs.files }}; do
            echo "== Processing: $file =="
            
            # Read frontmatter
            FM=$(sed -n '2,/^---$/p' "$file" | head -n -1)
            
            # Parse all fields
            get_field() { echo "$FM" | grep "^$1:" | sed "s/^$1: *//" | sed 's/^"//;s/"$//;s/^null$//' | tr -d '\r'; }
            
            ID=$(get_field id)
            TITLE=$(get_field title)
            STATUS=$(get_field status)
            CU_ID=$(get_field clickup_task_id)
            EPIC=$(get_field epic_id)
            ASSIGNED=$(get_field assigned_to)
            PRIORITY=$(get_field priority)
            START_DATE=$(get_field start_date)
            DUE_DATE=$(get_field due_date)
            TIME_EST=$(get_field time_estimate)
            STORY_POINTS=$(get_field story_points)
            
            echo "  $ID: $TITLE | Status: $STATUS | Priority: $PRIORITY"
            
            # Build assignees array
            ASSIGNEES="[]"
            if [ -n "$ASSIGNED" ]; then
              CLEAN_ASSIGNED=$(echo "$ASSIGNED" | tr -d '[]"' | tr ',' '\n')
              ASSIGNEE_IDS=""
              for email in $CLEAN_ASSIGNED; do
                email=$(echo "$email" | xargs)
                uid=$(get_user_id "$email")
                [ -n "$uid" ] && ASSIGNEE_IDS="$ASSIGNEE_IDS$uid,"
              done
              if [ -n "$ASSIGNEE_IDS" ]; then
                ASSIGNEES=$(echo "$ASSIGNEE_IDS" | sed 's/,$//' | tr ',' '\n' | jq -R -s -c 'split("\n") | map(select(length > 0) | tonumber)')
              fi
            else
              AUTHOR_UID=$(get_user_id "$COMMIT_AUTHOR")
              [ -n "$AUTHOR_UID" ] && ASSIGNEES="[$AUTHOR_UID]"
            fi
            
            # Set type and list
            if [[ "$file" == *"/epics/"* ]]; then
              TYPE="epic"
              LIST="$EPICS_LIST"
              case "$STATUS" in to-do) CU_ST="to do";; in-progress) CU_ST="in progress";; done) CU_ST="complete";; cancelled) CU_ST="cancelled";; *) CU_ST="to do";; esac
            else
              TYPE="story"
              LIST="$STORIES_LIST"
              case "$STATUS" in to-do) CU_ST="Open";; scoping) CU_ST="scoping";; in-design) CU_ST="in design";; ready-for-dev|in-progress) CU_ST="ready for dev";; cancelled) CU_ST="cancelled";; *) CU_ST="Open";; esac
            fi
            
            # Get description
            DESC=$(awk 'BEGIN{c=0} /^---$/{c++;next} c>=2{print}' "$file" | head -50)
            if [ -n "$EPIC" ]; then
              FULL_DESC=$(printf "**Epic**: %s\n\n---\n\n%s\n\n---\n_Source: %s_" "$EPIC" "$DESC" "$file")
            else
              FULL_DESC=$(printf "%s\n\n---\n_Source: %s_" "$DESC" "$file")
            fi
            
            # Build JSON payload with all fields
            NAME="[$TYPE] $TITLE"
            
            # Base payload
            PAYLOAD=$(jq -n \
              --arg n "$NAME" \
              --arg d "$FULL_DESC" \
              --arg s "$CU_ST" \
              --arg t "$TYPE" \
              --argjson a "$ASSIGNEES" \
              '{name:$n, description:$d, status:$s, tags:["bmad",$t], assignees:$a}')
            
            # Add optional fields
            PRI_NUM=$(priority_to_num "$PRIORITY")
            [ -n "$PRI_NUM" ] && PAYLOAD=$(echo "$PAYLOAD" | jq --argjson p "$PRI_NUM" '. + {priority:$p}')
            
            START_MS=$(date_to_ms "$START_DATE")
            [ -n "$START_MS" ] && PAYLOAD=$(echo "$PAYLOAD" | jq --argjson s "$START_MS" '. + {start_date:$s}')
            
            DUE_MS=$(date_to_ms "$DUE_DATE")
            [ -n "$DUE_MS" ] && PAYLOAD=$(echo "$PAYLOAD" | jq --argjson d "$DUE_MS" '. + {due_date:$d}')
            
            TIME_MS=$(hours_to_ms "$TIME_EST")
            [ -n "$TIME_MS" ] && PAYLOAD=$(echo "$PAYLOAD" | jq --argjson t "$TIME_MS" '. + {time_estimate:$t}')
            
            # Add link to epic if this is a story
            if [ "$TYPE" = "story" ] && [ -n "$EPIC" ] && [ -n "${EPIC_CU_MAP[$EPIC]}" ]; then
              EPIC_CU="${EPIC_CU_MAP[$EPIC]}"
              PAYLOAD=$(echo "$PAYLOAD" | jq --arg l "$EPIC_CU" '. + {links_to:$l}')
              echo "  Linking to Epic $EPIC -> $EPIC_CU"
            fi
            
            if [ -z "$CU_ID" ]; then
              echo "  Creating task..."
              RES=$(curl -sf -X POST "https://api.clickup.com/api/v2/list/$LIST/task" \
                -H "Authorization: $CLICKUP_API_KEY" \
                -H "Content-Type: application/json" \
                -d "$PAYLOAD" 2>&1) || { echo "  API Error: $RES"; continue; }
              
              NEW_ID=$(echo "$RES" | jq -r '.id // empty')
              if [ -n "$NEW_ID" ]; then
                echo "  Created: $NEW_ID"
                sed -i "s/^clickup_task_id:.*/clickup_task_id: \"$NEW_ID\"/" "$file"
                # Update epic map if this is an epic
                [ "$TYPE" = "epic" ] && EPIC_CU_MAP["$ID"]="$NEW_ID"
              else
                echo "  Failed: $RES"
              fi
            else
              echo "  Updating $CU_ID..."
              # Remove links_to for updates (only for create)
              UP_PAYLOAD=$(echo "$PAYLOAD" | jq 'del(.links_to)')
              curl -sf -X PUT "https://api.clickup.com/api/v2/task/$CU_ID" \
                -H "Authorization: $CLICKUP_API_KEY" \
                -H "Content-Type: application/json" \
                -d "$UP_PAYLOAD" > /dev/null 2>&1 || echo "  Update failed"
              echo "  Updated"
            fi
          done
          echo "Sync complete"

      - name: Commit ClickUp IDs
        if: steps.changed.outputs.files != ''
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add _bmad-output/
          git diff --staged --quiet || { git commit -m "chore: Update ClickUp IDs [skip ci]" && git push; }
