name: Sync BMAD Artifacts to ClickUp

on:
  push:
    branches: [main]
    paths:
      - '_bmad-output/epics/**/*.md'
      - '_bmad-output/stories/**/*.md'

env:
  CLICKUP_EPICS_LIST_ID: "901815396322"
  CLICKUP_STORIES_LIST_ID: "901815396340"
  # Email to ClickUp User ID mapping (add more as needed)
  # Format: email1:id1,email2:id2
  EMAIL_TO_CLICKUP_ID: "work.huutrung@gmail.com:300697285,mazhnguyen@kwayvina.com:300697285"

permissions:
  contents: write

jobs:
  sync-to-clickup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Changed Files and Commit Author
        id: changed
        run: |
          CHANGED=$(git diff --name-only HEAD^ HEAD 2>/dev/null | grep -E '_bmad-output/(epics|stories)/.*\.md$' | tr '\n' ' ' || echo "")
          AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
          echo "files=$CHANGED" >> $GITHUB_OUTPUT
          echo "author_email=$AUTHOR_EMAIL" >> $GITHUB_OUTPUT
          echo "Found files: $CHANGED"
          echo "Commit author: $AUTHOR_EMAIL"

      - name: Sync to ClickUp
        if: steps.changed.outputs.files != ''
        env:
          CLICKUP_API_KEY: ${{ secrets.CLICKUP_API_KEY }}
          EPICS_LIST: ${{ env.CLICKUP_EPICS_LIST_ID }}
          STORIES_LIST: ${{ env.CLICKUP_STORIES_LIST_ID }}
          EMAIL_MAP: ${{ env.EMAIL_TO_CLICKUP_ID }}
          COMMIT_AUTHOR: ${{ steps.changed.outputs.author_email }}
        run: |
          echo "Starting sync..."
          
          # Function to get ClickUp user ID from email
          get_user_id() {
            local email="$1"
            echo "$EMAIL_MAP" | tr ',' '\n' | grep "^$email:" | cut -d':' -f2
          }
          
          for file in ${{ steps.changed.outputs.files }}; do
            echo "== Processing: $file =="
            
            # Read frontmatter
            FM=$(sed -n '2,/^---$/p' "$file" | head -n -1)
            
            # Parse fields
            get_field() { echo "$FM" | grep "^$1:" | sed "s/^$1: *//" | sed 's/^"//;s/"$//;s/^null$//' | tr -d '\r'; }
            
            ID=$(get_field id)
            TITLE=$(get_field title)
            STATUS=$(get_field status)
            CU_ID=$(get_field clickup_task_id)
            EPIC=$(get_field epic_id)
            ASSIGNED=$(get_field assigned_to)
            
            echo "  Title: $TITLE | Status: $STATUS | Assigned: $ASSIGNED"
            
            # Build assignees array
            ASSIGNEES="[]"
            if [ -n "$ASSIGNED" ]; then
              # Handle both single value and array format: "email" or ["email1", "email2"]
              CLEAN_ASSIGNED=$(echo "$ASSIGNED" | tr -d '[]"' | tr ',' '\n')
              ASSIGNEE_IDS=""
              for email in $CLEAN_ASSIGNED; do
                email=$(echo "$email" | xargs) # trim whitespace
                uid=$(get_user_id "$email")
                if [ -n "$uid" ]; then
                  ASSIGNEE_IDS="$ASSIGNEE_IDS$uid,"
                fi
              done
              if [ -n "$ASSIGNEE_IDS" ]; then
                # Remove trailing comma and format as JSON array
                ASSIGNEES=$(echo "$ASSIGNEE_IDS" | sed 's/,$//' | tr ',' '\n' | jq -R -s -c 'split("\n") | map(select(length > 0) | tonumber)')
              fi
            else
              # Auto-assign to commit author if no explicit assignee
              AUTHOR_UID=$(get_user_id "$COMMIT_AUTHOR")
              if [ -n "$AUTHOR_UID" ]; then
                ASSIGNEES="[$AUTHOR_UID]"
                echo "  Auto-assigning to commit author: $COMMIT_AUTHOR -> $AUTHOR_UID"
              fi
            fi
            echo "  Assignees: $ASSIGNEES"
            
            # Set type and list
            if [[ "$file" == *"/epics/"* ]]; then
              TYPE="epic"
              LIST="$EPICS_LIST"
              case "$STATUS" in to-do) CU_ST="to do";; in-progress) CU_ST="in progress";; done) CU_ST="complete";; cancelled) CU_ST="cancelled";; *) CU_ST="to do";; esac
            else
              TYPE="story"
              LIST="$STORIES_LIST"
              case "$STATUS" in to-do) CU_ST="Open";; scoping) CU_ST="scoping";; in-design) CU_ST="in design";; ready-for-dev|in-progress) CU_ST="ready for dev";; cancelled) CU_ST="cancelled";; *) CU_ST="Open";; esac
            fi
            
            # Get description using awk (content after 2nd ---)
            DESC=$(awk 'BEGIN{c=0} /^---$/{c++;next} c>=2{print}' "$file" | head -50)
            
            # Build full description using printf
            if [ -n "$EPIC" ]; then
              FULL_DESC=$(printf "**Epic**: %s\n\n---\n\n%s\n\n---\n_Source: %s_" "$EPIC" "$DESC" "$file")
            else
              FULL_DESC=$(printf "%s\n\n---\n_Source: %s_" "$DESC" "$file")
            fi
            
            # Build JSON with assignees
            NAME="[$TYPE] $TITLE"
            JSON=$(jq -n --arg n "$NAME" --arg d "$FULL_DESC" --arg s "$CU_ST" --arg t "$TYPE" --argjson a "$ASSIGNEES" \
              '{name:$n, description:$d, status:$s, tags:["bmad",$t], assignees:$a}')
            
            if [ -z "$CU_ID" ]; then
              echo "  Creating task..."
              RES=$(curl -sf -X POST "https://api.clickup.com/api/v2/list/$LIST/task" \
                -H "Authorization: $CLICKUP_API_KEY" \
                -H "Content-Type: application/json" \
                -d "$JSON" 2>&1) || { echo "  API Error: $RES"; continue; }
              
              NEW_ID=$(echo "$RES" | jq -r '.id // empty')
              if [ -n "$NEW_ID" ]; then
                echo "  Created: $NEW_ID"
                sed -i "s/^clickup_task_id:.*/clickup_task_id: \"$NEW_ID\"/" "$file"
              else
                echo "  Failed: $RES"
              fi
            else
              echo "  Updating $CU_ID..."
              UPJSON=$(jq -n --arg n "$NAME" --arg d "$FULL_DESC" --arg s "$CU_ST" --argjson a "$ASSIGNEES" '{name:$n,description:$d,status:$s,assignees:$a}')
              curl -sf -X PUT "https://api.clickup.com/api/v2/task/$CU_ID" \
                -H "Authorization: $CLICKUP_API_KEY" \
                -H "Content-Type: application/json" \
                -d "$UPJSON" > /dev/null 2>&1 || echo "  Update failed"
              echo "  Updated"
            fi
          done
          echo "Sync complete"

      - name: Commit ClickUp IDs
        if: steps.changed.outputs.files != ''
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add _bmad-output/
          git diff --staged --quiet || { git commit -m "chore: Update ClickUp IDs [skip ci]" && git push; }
