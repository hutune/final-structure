# üí∞ Quy t·∫Øc Nghi·ªáp v·ª•: Module V√≠ & Thanh to√°n

**Phi√™n b·∫£n**: 1.0  
**Ng√†y**: 2026-01-23  
**Tr·∫°ng th√°i**: B·∫£n nh√°p  
**Ch·ªß qu·∫£n**: Product Team

---

## üìñ M·ª•c l·ª•c

1. [T·ªïng quan](#-t·ªïng-quan)
2. [C√°c th·ª±c th·ªÉ Domain](#-c√°c-th·ª±c-th·ªÉ-domain)
3. [V√≤ng ƒë·ªùi V√≠](#-v√≤ng-ƒë·ªùi-v√≠)
4. [Quy t·∫Øc Nghi·ªáp v·ª•](#-quy-t·∫Øc-nghi·ªáp-v·ª•)
5. [N·∫°p ti·ªÅn & X·ª≠ l√Ω Thanh to√°n](#-n·∫°p-ti·ªÅn--x·ª≠-l√Ω-thanh-to√°n)
6. [Qu·∫£n l√Ω Giao d·ªãch](#-qu·∫£n-l√Ω-giao-d·ªãch)
7. [X·ª≠ l√Ω Ho√†n ti·ªÅn](#-x·ª≠-l√Ω-ho√†n-ti·ªÅn)
8. [R√∫t ti·ªÅn Supplier](#-r√∫t-ti·ªÅn-supplier)
9. [Ti·ªÅn t·ªá & T·ª∑ gi√°](#-ti·ªÅn-t·ªá--t·ª∑-gi√°)
10. [X·ª≠ l√Ω Thu·∫ø](#-x·ª≠-l√Ω-thu·∫ø)
11. [ƒê·ªëi so√°t T√†i ch√≠nh](#-ƒë·ªëi-so√°t-t√†i-ch√≠nh)
12. [Ch·ªëng R·ª≠a ti·ªÅn (AML)](#-ch·ªëng-r·ª≠a-ti·ªÅn-aml)
13. [C√°c tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát](#-c√°c-tr∆∞·ªùng-h·ª£p-ƒë·∫∑c-bi·ªát)
14. [Quy t·∫Øc Ki·ªÉm tra](#-quy-t·∫Øc-ki·ªÉm-tra)
15. [C√¥ng th·ª©c T√≠nh to√°n](#-c√¥ng-th·ª©c-t√≠nh-to√°n)

---

## üéØ T·ªïng quan

### M·ª•c ƒë√≠ch

T√†i li·ªáu n√†y ƒë·ªãnh nghƒ©a T·∫§T C·∫¢ quy t·∫Øc nghi·ªáp v·ª• cho module V√≠ & Thanh to√°n, bao g·ªìm giao d·ªãch t√†i ch√≠nh, x·ª≠ l√Ω thanh to√°n, ho√†n ti·ªÅn, r√∫t ti·ªÅn v√† y√™u c·∫ßu tu√¢n th·ªß.

### Ph·∫°m vi

**Bao g·ªìm:**
- ‚úÖ Qu·∫£n l√Ω v√≠ (Advertiser & Supplier)
- ‚úÖ C√°c lo·∫°i s·ªë d∆∞ v√† chuy·ªÉn ƒë·ªïi
- ‚úÖ T√≠ch h·ª£p c·ªïng thanh to√°n
- ‚úÖ Quy tr√¨nh n·∫°p v√† r√∫t ti·ªÅn
- ‚úÖ Ghi nh·∫≠n v√† ki·ªÉm to√°n giao d·ªãch
- ‚úÖ X·ª≠ l√Ω ho√†n ti·ªÅn
- ‚úÖ T√≠nh thu·∫ø v√† tu√¢n th·ªß
- ‚úÖ Chuy·ªÉn ƒë·ªïi ti·ªÅn t·ªá
- ‚úÖ ƒê·ªëi so√°t t√†i ch√≠nh
- ‚úÖ Tu√¢n th·ªß ch·ªëng r·ª≠a ti·ªÅn (AML)

**KH√îNG bao g·ªìm:**
- ‚ùå T√≠nh ph√≠ chi·∫øn d·ªãch (xem module Campaign)
- ‚ùå Chi ph√≠ impression (xem module Campaign/Impression)
- ‚ùå T√≠nh doanh thu supplier (xem module Campaign/Supplier)

### Kh√°i ni·ªám Ch·ªß ch·ªët

| Thu·∫≠t ng·ªØ | ƒê·ªãnh nghƒ©a |
|-----------|------------|
| **Wallet (V√≠)** | T√†i kho·∫£n k·ªπ thu·∫≠t s·ªë ch·ª©a ti·ªÅn c·ªßa ng∆∞·ªùi d√πng |
| **Balance Types** | S·ªë d∆∞ Kh·∫£ d·ª•ng, Gi·ªØ, ƒêang ch·ªù |
| **Transaction (Giao d·ªãch)** | B·∫£n ghi b·∫•t bi·∫øn v·ªÅ thay ƒë·ªïi s·ªë d∆∞ |
| **Top-up (N·∫°p ti·ªÅn)** | Th√™m ti·ªÅn v√†o v√≠ advertiser |
| **Withdrawal (R√∫t ti·ªÅn)** | Chuy·ªÉn ti·ªÅn t·ª´ v√≠ supplier v·ªÅ ng√¢n h√†ng |
| **Reconciliation (ƒê·ªëi so√°t)** | X√°c minh ƒë·ªô ch√≠nh x√°c t√†i ch√≠nh h√†ng ng√†y |

---

## üì¶ C√°c th·ª±c th·ªÉ Domain

### 1. Wallet (V√≠)

> **ƒê·ªãnh nghƒ©a**: T√†i kho·∫£n k·ªπ thu·∫≠t s·ªë ƒë·ªÉ qu·∫£n l√Ω ti·ªÅn tr√™n n·ªÅn t·∫£ng.

#### C√°c thu·ªôc t√≠nh

| Tr∆∞·ªùng | Ki·ªÉu | B·∫Øt bu·ªôc | M·∫∑c ƒë·ªãnh | Quy t·∫Øc nghi·ªáp v·ª• |
|--------|------|----------|----------|-------------------|
| `id` | UUID | C√≥ | T·ª± ƒë·ªông t·∫°o | Kh√¥ng thay ƒë·ªïi |
| `user_id` | UUID | C√≥ | - | M·ªôt v√≠ m·ªói ng∆∞·ªùi d√πng |
| `user_type` | Enum | C√≥ | - | ADVERTISER / SUPPLIER |
| `currency` | String(3) | C√≥ | "USD" | M√£ ISO 4217 |
| `available_balance` | Decimal(12,2) | C√≥ | 0.00 | Ti·ªÅn c√≥ th·ªÉ d√πng ngay |
| `held_balance` | Decimal(12,2) | C√≥ | 0.00 | Ti·ªÅn b·ªã kh√≥a/k√Ω qu·ªπ |
| `pending_balance` | Decimal(12,2) | C√≥ | 0.00 | N·∫°p/r√∫t ƒëang x·ª≠ l√Ω |
| `lifetime_deposits` | Decimal(12,2) | C√≥ | 0.00 | T·ªïng n·∫°p t·ª´ tr∆∞·ªõc ƒë·∫øn nay |
| `lifetime_withdrawals` | Decimal(12,2) | C√≥ | 0.00 | T·ªïng r√∫t t·ª´ tr∆∞·ªõc ƒë·∫øn nay |
| `lifetime_spent` | Decimal(12,2) | C√≥ | 0.00 | T·ªïng chi chi·∫øn d·ªãch (advertiser) |
| `lifetime_earned` | Decimal(12,2) | C√≥ | 0.00 | T·ªïng doanh thu (supplier) |
| `min_balance_alert` | Decimal(12,2) | Kh√¥ng | null | C·∫£nh b√°o khi s·ªë d∆∞ d∆∞·ªõi m·ª©c |
| `max_balance_limit` | Decimal(12,2) | Kh√¥ng | null | S·ªë d∆∞ t·ªëi ƒëa cho ph√©p |
| `status` | Enum | C√≥ | ACTIVE | ACTIVE / FROZEN / SUSPENDED |
| `frozen_reason` | String(200) | Kh√¥ng | null | L√Ω do ƒë√≥ng bƒÉng v√≠ |
| `frozen_at` | DateTime | Kh√¥ng | null | Th·ªùi ƒëi·ªÉm ƒë√≥ng bƒÉng |
| `last_topup_at` | DateTime | Kh√¥ng | null | N·∫°p ti·ªÅn g·∫ßn nh·∫•t |
| `last_withdrawal_at` | DateTime | Kh√¥ng | null | R√∫t ti·ªÅn g·∫ßn nh·∫•t |
| `created_at` | DateTime | C√≥ | B√ÇY GI·ªú() | Kh√¥ng thay ƒë·ªïi |
| `updated_at` | DateTime | C√≥ | B√ÇY GI·ªú() | T·ª± ƒë·ªông c·∫≠p nh·∫≠t |

#### B·∫•t bi·∫øn S·ªë d∆∞

```
C√¥ng th·ª©c c∆° b·∫£n:
total_balance = available_balance + held_balance + pending_balance

// Ph·∫£i lu√¥n b·∫±ng t·ªïng t·∫•t c·∫£ giao d·ªãch
total_balance == SUM(transactions.amount WHERE type IN [CREDIT, DEBIT])

Gi·∫£i th√≠ch:
‚Ä¢ available_balance: Ti·ªÅn c√≥ th·ªÉ d√πng ngay cho chi·∫øn d·ªãch ho·∫∑c r√∫t
‚Ä¢ held_balance: Ti·ªÅn b·ªã kh√≥a t·∫°m th·ªùi (ng√¢n s√°ch chi·∫øn d·ªãch, tranh ch·∫•p)
‚Ä¢ pending_balance: Ti·ªÅn ƒëang x·ª≠ l√Ω (n·∫°p/r√∫t ch∆∞a ho√†n th√†nh)
```

---

### 2. WalletTransaction (Giao d·ªãch V√≠)

> **ƒê·ªãnh nghƒ©a**: B·∫£n ghi b·∫•t bi·∫øn v·ªÅ s·ª± ki·ªán thay ƒë·ªïi s·ªë d∆∞.

#### C√°c thu·ªôc t√≠nh

| Tr∆∞·ªùng | Ki·ªÉu | B·∫Øt bu·ªôc | Quy t·∫Øc nghi·ªáp v·ª• |
|--------|------|----------|-------------------|
| `id` | UUID | C√≥ | T·ª± ƒë·ªông t·∫°o |
| `wallet_id` | UUID | C√≥ | V√≠ ngu·ªìn |
| `transaction_type` | Enum | C√≥ | Xem [Lo·∫°i Giao d·ªãch](#lo·∫°i-giao-d·ªãch) |
| `amount` | Decimal(12,2) | C√≥ | Lu√¥n d∆∞∆°ng (type ch·ªâ chi·ªÅu) |
| `currency` | String(3) | C√≥ | M√£ ISO 4217 |
| `balance_before` | Decimal(12,2) | C√≥ | Snapshot tr∆∞·ªõc giao d·ªãch |
| `balance_after` | Decimal(12,2) | C√≥ | Snapshot sau giao d·ªãch |
| `balance_type_affected` | Enum | C√≥ | AVAILABLE / HELD / PENDING |
| `status` | Enum | C√≥ | PENDING / COMPLETED / FAILED / REVERSED |
| `reference_type` | String(50) | Kh√¥ng | Campaign, Impression, Withdrawal, v.v. |
| `reference_id` | UUID | Kh√¥ng | Link ƒë·∫øn th·ª±c th·ªÉ li√™n quan |
| `payment_method` | Enum | Kh√¥ng | CARD / BANK_TRANSFER / WALLET / OTHER |
| `payment_gateway` | Enum | Kh√¥ng | STRIPE / PAYPAL / BANK / MANUAL |
| `gateway_transaction_id` | String(100) | Kh√¥ng | ID thanh to√°n b√™n ngo√†i |
| `description` | Text | C√≥ | M√¥ t·∫£ d·ªÖ ƒë·ªçc |
| `metadata` | JSON | Kh√¥ng | D·ªØ li·ªáu b·ªï sung |
| `fee_amount` | Decimal(12,2) | C√≥ | Ph√≠ giao d·ªãch (m·∫∑c ƒë·ªãnh: 0.00) |
| `tax_amount` | Decimal(12,2) | C√≥ | Thu·∫ø kh·∫•u tr·ª´ (m·∫∑c ƒë·ªãnh: 0.00) |
| `net_amount` | Decimal(12,2) | C√≥ | amount - fee - tax |
| `processed_by` | UUID | Kh√¥ng | User/Admin kh·ªüi t·∫°o |
| `processed_at` | DateTime | C√≥ | Khi giao d·ªãch th·ª±c hi·ªán |
| `reversed_at` | DateTime | Kh√¥ng | Khi ƒë·∫£o ng∆∞·ª£c (n·∫øu c√≥) |
| `reversal_reason` | String(200) | Kh√¥ng | L√Ω do ƒë·∫£o ng∆∞·ª£c |
| `created_at` | DateTime | C√≥ | Kh√¥ng thay ƒë·ªïi |

#### Lo·∫°i Giao d·ªãch

```
Credit (tƒÉng s·ªë d∆∞):
‚Ä¢ DEPOSIT: Ng∆∞·ªùi d√πng n·∫°p ti·ªÅn
‚Ä¢ REFUND: Ho√†n ti·ªÅn ng√¢n s√°ch chi·∫øn d·ªãch
‚Ä¢ REVENUE: Thu nh·∫≠p supplier
‚Ä¢ ADJUSTMENT_CREDIT: ƒêi·ªÅu ch·ªânh th·ªß c√¥ng (admin)
‚Ä¢ BONUS: Khuy·∫øn kh√≠ch t·ª´ n·ªÅn t·∫£ng

Debit (gi·∫£m s·ªë d∆∞):
‚Ä¢ CAMPAIGN_HOLD: Ng√¢n s√°ch k√Ω qu·ªπ cho chi·∫øn d·ªãch
‚Ä¢ CAMPAIGN_CHARGE: T√≠nh ph√≠ impression
‚Ä¢ WITHDRAWAL: R√∫t ti·ªÅn supplier
‚Ä¢ FEE: Ph√≠ n·ªÅn t·∫£ng/giao d·ªãch
‚Ä¢ TAX_WITHHOLDING: Kh·∫•u tr·ª´ thu·∫ø
‚Ä¢ ADJUSTMENT_DEBIT: ƒêi·ªÅu ch·ªânh th·ªß c√¥ng (admin)
‚Ä¢ CHARGEBACK: Impression b·ªã tranh ch·∫•p

Hold/Release (kh√¥ng thay ƒë·ªïi t·ªïng s·ªë d∆∞):
‚Ä¢ HOLD: Chuy·ªÉn available ‚Üí held
‚Ä¢ RELEASE: Chuy·ªÉn held ‚Üí available

Pending (ƒëang x·ª≠ l√Ω):
‚Ä¢ PENDING_DEPOSIT: N·∫°p ti·ªÅn ƒëang x·ª≠ l√Ω
‚Ä¢ PENDING_WITHDRAWAL: R√∫t ti·ªÅn ƒëang x·ª≠ l√Ω
```

---

### 3. PaymentMethod (Ph∆∞∆°ng th·ª©c Thanh to√°n)

> **ƒê·ªãnh nghƒ©a**: Ph∆∞∆°ng th·ª©c thanh to√°n ƒë√£ l∆∞u c·ªßa ng∆∞·ªùi d√πng.

#### C√°c thu·ªôc t√≠nh

| Tr∆∞·ªùng | Ki·ªÉu | B·∫Øt bu·ªôc | Quy t·∫Øc nghi·ªáp v·ª• |
|--------|------|----------|-------------------|
| `id` | UUID | C√≥ | T·ª± ƒë·ªông t·∫°o |
| `user_id` | UUID | C√≥ | Ch·ªß s·ªü h·ªØu |
| `type` | Enum | C√≥ | CREDIT_CARD / DEBIT_CARD / BANK_ACCOUNT |
| `provider` | Enum | C√≥ | STRIPE / PAYPAL |
| `provider_payment_method_id` | String(100) | C√≥ | ID PM c·ªßa gateway |
| `is_default` | Boolean | C√≥ | M·∫∑c ƒë·ªãnh cho n·∫°p ti·ªÅn |
| `card_last4` | String(4) | Kh√¥ng | 4 s·ªë cu·ªëi (n·∫øu th·∫ª) |
| `card_brand` | String(20) | Kh√¥ng | Visa, Mastercard, v.v. |
| `card_exp_month` | Integer | Kh√¥ng | Th√°ng h·∫øt h·∫°n (1-12) |
| `card_exp_year` | Integer | Kh√¥ng | NƒÉm h·∫øt h·∫°n |
| `bank_name` | String(100) | Kh√¥ng | T√™n ng√¢n h√†ng (n·∫øu TK ng√¢n h√†ng) |
| `bank_account_last4` | String(4) | Kh√¥ng | 4 s·ªë cu·ªëi TK |
| `billing_address` | JSON | Kh√¥ng | Chi ti·∫øt ƒë·ªãa ch·ªâ |
| `status` | Enum | C√≥ | ACTIVE / EXPIRED / FAILED |
| `verified_at` | DateTime | Kh√¥ng | Khi ƒë∆∞·ª£c x√°c minh |
| `last_used_at` | DateTime | Kh√¥ng | S·ª≠ d·ª•ng g·∫ßn nh·∫•t |
| `created_at` | DateTime | C√≥ | Kh√¥ng thay ƒë·ªïi |

---

### 4. WithdrawalRequest (Y√™u c·∫ßu R√∫t ti·ªÅn)

> **ƒê·ªãnh nghƒ©a**: Y√™u c·∫ßu c·ªßa supplier chuy·ªÉn ti·ªÅn v·ªÅ t√†i kho·∫£n ng√¢n h√†ng.

#### C√°c thu·ªôc t√≠nh

| Tr∆∞·ªùng | Ki·ªÉu | B·∫Øt bu·ªôc | Quy t·∫Øc nghi·ªáp v·ª• |
|--------|------|----------|-------------------|
| `id` | UUID | C√≥ | T·ª± ƒë·ªông t·∫°o |
| `wallet_id` | UUID | C√≥ | V√≠ supplier |
| `supplier_id` | UUID | C√≥ | Ng∆∞·ªùi y√™u c·∫ßu |
| `amount` | Decimal(12,2) | C√≥ | S·ªë ti·ªÅn r√∫t |
| `currency` | String(3) | C√≥ | M√£ ISO 4217 |
| `fee_amount` | Decimal(12,2) | C√≥ | Ph√≠ r√∫t ti·ªÅn |
| `tax_amount` | Decimal(12,2) | C√≥ | Thu·∫ø kh·∫•u tr·ª´ |
| `net_amount` | Decimal(12,2) | C√≥ | amount - fee - tax |
| `bank_account_name` | String(100) | C√≥ | T√™n ng∆∞·ªùi nh·∫≠n |
| `bank_account_number` | String(50) | C√≥ | S·ªë t√†i kho·∫£n (m√£ h√≥a) |
| `bank_routing_number` | String(20) | C√≥ | M√£ routing/SWIFT |
| `bank_name` | String(100) | C√≥ | T√™n ng√¢n h√†ng |
| `bank_country` | String(2) | C√≥ | M√£ qu·ªëc gia ISO |
| `status` | Enum | C√≥ | Xem [Tr·∫°ng th√°i R√∫t ti·ªÅn](#tr·∫°ng-th√°i-r√∫t-ti·ªÅn) |
| `requested_at` | DateTime | C√≥ | Khi g·ª≠i y√™u c·∫ßu |
| `approved_at` | DateTime | Kh√¥ng | Khi admin duy·ªát |
| `approved_by` | UUID | Kh√¥ng | Admin duy·ªát |
| `processed_at` | DateTime | Kh√¥ng | Khi thanh to√°n g·ª≠i |
| `completed_at` | DateTime | Kh√¥ng | Khi x√°c nh·∫≠n nh·∫≠n ƒë∆∞·ª£c |
| `failed_at` | DateTime | Kh√¥ng | Khi th·∫•t b·∫°i |
| `failure_reason` | String(200) | Kh√¥ng | L√Ω do th·∫•t b·∫°i |
| `reference_number` | String(50) | Kh√¥ng | M√£ tham chi·∫øu ng√¢n h√†ng |
| `retry_count` | Integer | C√≥ | S·ªë l·∫ßn th·ª≠ l·∫°i (m·∫∑c ƒë·ªãnh: 0) |

#### Tr·∫°ng th√°i R√∫t ti·ªÅn

```
Lu·ªìng b√¨nh th∆∞·ªùng:
PENDING ‚Üí APPROVED ‚Üí PROCESSING ‚Üí COMPLETED

Lu·ªìng th·∫•t b·∫°i v√† th·ª≠ l·∫°i:
PENDING ‚Üí APPROVED ‚Üí PROCESSING ‚Üí FAILED ‚Üí RETRY ‚Üí PROCESSING ‚Üí COMPLETED

Lu·ªìng h·ªßy:
PENDING ‚Üí CANCELLED

Gi·∫£i th√≠ch:
‚Ä¢ PENDING: Ch·ªù duy·ªát admin (< $5k: t·ª± ƒë·ªông, >= $5k: th·ªß c√¥ng)
‚Ä¢ APPROVED: ƒê√£ duy·ªát, chu·∫©n b·ªã x·ª≠ l√Ω
‚Ä¢ PROCESSING: ƒêang g·ª≠i chuy·ªÉn kho·∫£n ng√¢n h√†ng
‚Ä¢ COMPLETED: Ti·ªÅn ƒë√£ ƒë·∫øn t√†i kho·∫£n (3-5 ng√†y)
‚Ä¢ FAILED: L·ªói (TK sai, TK ƒë√≥ng, v.v.)
‚Ä¢ RETRY: Th·ª≠ l·∫°i sau khi s·ª≠a l·ªói
‚Ä¢ CANCELLED: H·ªßy b·ªüi user/admin
```

---

### 5. RefundRequest (Y√™u c·∫ßu Ho√†n ti·ªÅn)

> **ƒê·ªãnh nghƒ©a**: Y√™u c·∫ßu ho√†n ti·ªÅn c·ªßa advertiser.

#### C√°c thu·ªôc t√≠nh

| Tr∆∞·ªùng | Ki·ªÉu | B·∫Øt bu·ªôc | Quy t·∫Øc nghi·ªáp v·ª• |
|--------|------|----------|-------------------|
| `id` | UUID | C√≥ | T·ª± ƒë·ªông t·∫°o |
| `wallet_id` | UUID | C√≥ | V√≠ advertiser |
| `advertiser_id` | UUID | C√≥ | Ng∆∞·ªùi y√™u c·∫ßu |
| `campaign_id` | UUID | Kh√¥ng | Chi·∫øn d·ªãch li√™n quan (n·∫øu c√≥) |
| `amount` | Decimal(12,2) | C√≥ | S·ªë ti·ªÅn ho√†n |
| `refund_type` | Enum | C√≥ | CAMPAIGN_CANCELLED / UNUSED_BUDGET / DISPUTE / OTHER |
| `reason` | Text | C√≥ | L√Ω do y√™u c·∫ßu ho√†n ti·ªÅn |
| `status` | Enum | C√≥ | PENDING / APPROVED / REJECTED / COMPLETED |
| `requested_at` | DateTime | C√≥ | Khi g·ª≠i y√™u c·∫ßu |
| `approved_at` | DateTime | Kh√¥ng | Khi ƒë∆∞·ª£c duy·ªát |
| `approved_by` | UUID | Kh√¥ng | Admin duy·ªát |
| `processed_at` | DateTime | Kh√¥ng | Khi ho√†n ti·ªÅn ph√°t h√†nh |
| `rejection_reason` | String(200) | Kh√¥ng | L√Ω do t·ª´ ch·ªëi |

---

### 6. DailyReconciliation (ƒê·ªëi so√°t H√†ng ng√†y)

> **ƒê·ªãnh nghƒ©a**: Ki·ªÉm tra ƒë·ªô ch√≠nh x√°c t√†i ch√≠nh h√†ng ng√†y.

#### C√°c thu·ªôc t√≠nh

| Tr∆∞·ªùng | Ki·ªÉu | B·∫Øt bu·ªôc | Quy t·∫Øc nghi·ªáp v·ª• |
|--------|------|----------|-------------------|
| `id` | UUID | C√≥ | T·ª± ƒë·ªông t·∫°o |
| `reconciliation_date` | Date | C√≥ | Ng√†y kinh doanh ƒë∆∞·ª£c ƒë·ªëi so√°t |
| `total_deposits` | Decimal(12,2) | C√≥ | T·ªïng t·∫•t c·∫£ n·∫°p ti·ªÅn |
| `total_withdrawals` | Decimal(12,2) | C√≥ | T·ªïng t·∫•t c·∫£ r√∫t ti·ªÅn |
| `total_campaign_spending` | Decimal(12,2) | C√≥ | T·ªïng chi ti√™u chi·∫øn d·ªãch |
| `total_supplier_revenue` | Decimal(12,2) | C√≥ | T·ªïng doanh thu supplier |
| `platform_revenue` | Decimal(12,2) | C√≥ | Ph·∫ßn 20% c·ªßa n·ªÅn t·∫£ng |
| `expected_balance` | Decimal(12,2) | C√≥ | T·ªïng t√≠nh to√°n |
| `actual_balance` | Decimal(12,2) | C√≥ | T·ªïng s·ªë d∆∞ v√≠ th·ª±c t·∫ø |
| `discrepancy` | Decimal(12,2) | C√≥ | expected - actual |
| `status` | Enum | C√≥ | PENDING / BALANCED / DISCREPANCY / RESOLVED |
| `discrepancy_reason` | Text | Kh√¥ng | Gi·∫£i th√≠ch n·∫øu c√≥ l·ªách |
| `reconciled_by` | UUID | Kh√¥ng | Admin ƒë·ªëi so√°t |
| `reconciled_at` | DateTime | Kh√¥ng | Khi ƒë·ªëi so√°t |
| `created_at` | DateTime | C√≥ | Kh√¥ng thay ƒë·ªïi |

---

## üîÑ V√≤ng ƒë·ªùi V√≠

### 1. T·∫°o V√≠

```
K√≠ch ho·∫°t: T√†i kho·∫£n ng∆∞·ªùi d√πng ƒë∆∞·ª£c t·∫°o (Advertiser ho·∫∑c Supplier)

Quy tr√¨nh:
1. T·∫°o v√≠ t·ª± ƒë·ªông:
   Wallet.create(
     user_id: new_user.id,
     user_type: new_user.type, // ADVERTISER ho·∫∑c SUPPLIER
     currency: new_user.country.default_currency HO·∫∂C "USD",
     available_balance: 0.00,
     held_balance: 0.00,
     pending_balance: 0.00,
     status: ACTIVE
   )

2. Kh·ªüi t·∫°o nh·∫≠t k√Ω giao d·ªãch:
   WalletTransaction.create(
     wallet_id: wallet.id,
     transaction_type: ADJUSTMENT_CREDIT,
     amount: 0.00,
     balance_before: 0.00,
     balance_after: 0.00,
     description: "V√≠ ƒë∆∞·ª£c kh·ªüi t·∫°o",
     status: COMPLETED
   )

3. ƒê·∫∑t gi·ªõi h·∫°n m·∫∑c ƒë·ªãnh:
   N·∫æU user_type = ADVERTISER:
     wallet.max_balance_limit = 100,000.00 // T·ªëi ƒëa $100k
     wallet.min_balance_alert = 100.00     // C·∫£nh b√°o d∆∞·ªõi $100
   NG∆Ø·ª¢C L·∫†I N·∫æU user_type = SUPPLIER:
     wallet.max_balance_limit = null        // Kh√¥ng gi·ªõi h·∫°n
     wallet.min_balance_alert = 1,000.00   // C·∫£nh b√°o d∆∞·ªõi $1k

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ M·ªôt v√≠ m·ªói ng∆∞·ªùi d√πng (quan h·ªá 1:1 nghi√™m ng·∫∑t)
‚Ä¢ T·∫°o t·ª± ƒë·ªông khi ƒëƒÉng k√Ω
‚Ä¢ S·ªë d∆∞ ban ƒë·∫ßu lu√¥n 0.00
‚Ä¢ Ti·ªÅn t·ªá d·ª±a tr√™n qu·ªëc gia (m·∫∑c ƒë·ªãnh: USD)
‚Ä¢ Status = ACTIVE m·∫∑c ƒë·ªãnh
‚Ä¢ Kh√¥ng thay ƒë·ªïi sau khi t·∫°o (kh√¥ng x√≥a v√≠)
```

---

## üìã Quy t·∫Øc Nghi·ªáp v·ª•

### Quy t·∫Øc 1: Qu·∫£n l√Ω S·ªë d∆∞

#### 1.1 C√°c lo·∫°i S·ªë d∆∞

**Available Balance (S·ªë d∆∞ Kh·∫£ d·ª•ng)**:
```
ƒê·ªãnh nghƒ©a: Ti·ªÅn c√≥ th·ªÉ d√πng ngay cho chi·∫øn d·ªãch ho·∫∑c r√∫t

ƒê·ªëi v·ªõi Advertiser:
‚Ä¢ C√≥ th·ªÉ t·∫°o chi·∫øn d·ªãch b·∫±ng s·ªë d∆∞ kh·∫£ d·ª•ng
‚Ä¢ Available = ti·ªÅn n·∫°p ch∆∞a b·ªã k√Ω qu·ªπ

ƒê·ªëi v·ªõi Supplier:
‚Ä¢ C√≥ th·ªÉ r√∫t s·ªë d∆∞ kh·∫£ d·ª•ng
‚Ä¢ Available = doanh thu ƒë√£ ki·∫øm v√† ƒë√£ gi·∫£i ph√≥ng (kh√¥ng b·ªã gi·ªØ)

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ Kh√¥ng bao gi·ªù √¢m (r√†ng bu·ªôc database)
‚Ä¢ TƒÉng b·ªüi: n·∫°p ti·ªÅn, ho√†n ti·ªÅn, gi·∫£i ph√≥ng gi·ªØ
‚Ä¢ Gi·∫£m b·ªüi: k√Ω qu·ªπ chi·∫øn d·ªãch, r√∫t ti·ªÅn, ph√≠
```

**Held Balance (S·ªë d∆∞ Gi·ªØ)**:
```
ƒê·ªãnh nghƒ©a: Ti·ªÅn t·∫°m th·ªùi b·ªã kh√≥a cho ho·∫°t ƒë·ªông ƒëang ch·ªù

ƒê·ªëi v·ªõi Advertiser:
‚Ä¢ Ng√¢n s√°ch chi·∫øn d·ªãch k√Ω qu·ªπ khi t·∫°o chi·∫øn d·ªãch
‚Ä¢ Gi·∫£i ph√≥ng khi chi·∫øn d·ªãch ho√†n th√†nh ho·∫∑c h·ªßy

ƒê·ªëi v·ªõi Supplier:
‚Ä¢ Doanh thu b·ªã gi·ªØ trong 7 ng√†y ch·ªëng gian l·∫≠n
‚Ä¢ Impression b·ªã tranh ch·∫•p gi·ªØ cho ƒë·∫øn khi gi·∫£i quy·∫øt

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ Kh√¥ng bao gi·ªù √¢m
‚Ä¢ TƒÉng b·ªüi: t·∫°o chi·∫øn d·ªãch, tranh ch·∫•p
‚Ä¢ Gi·∫£m b·ªüi: ho√†n th√†nh chi·∫øn d·ªãch, gi·∫£i quy·∫øt tranh ch·∫•p
‚Ä¢ T·ª± ƒë·ªông gi·∫£i ph√≥ng sau th·ªùi gian gi·ªØ
```

**Pending Balance (S·ªë d∆∞ ƒêang ch·ªù)**:
```
ƒê·ªãnh nghƒ©a: Ti·ªÅn ƒëang bay (n·∫°p/r√∫t ƒëang x·ª≠ l√Ω)

ƒê·ªëi v·ªõi Advertiser:
‚Ä¢ N·∫°p ti·ªÅn ƒëang x·ª≠ l√Ω (1-3 ng√†y chuy·ªÉn kho·∫£n NH)
‚Ä¢ Chuy·ªÉn sang available_balance khi cleared

ƒê·ªëi v·ªõi Supplier:
‚Ä¢ R√∫t ti·ªÅn ƒëang x·ª≠ l√Ω (3-5 ng√†y)
‚Ä¢ X√≥a kh·ªèi v√≠ khi wire ƒë√£ g·ª≠i

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ Kh√¥ng bao gi·ªù √¢m
‚Ä¢ Tr·∫°ng th√°i t·∫°m th·ªùi (t·ªëi ƒëa 7 ng√†y)
‚Ä¢ C·∫£nh b√°o n·∫øu pending > 7 ng√†y (c·∫ßn ƒëi·ªÅu tra)
‚Ä¢ Ho√†n l·∫°i n·∫øu thanh to√°n th·∫•t b·∫°i
```

#### 1.2 B·∫•t bi·∫øn S·ªë d∆∞

```
B·∫•t bi·∫øn 1: S·ªë d∆∞ kh√¥ng √¢m
available_balance >= 0
held_balance >= 0
pending_balance >= 0

B·∫•t bi·∫øn 2: ƒê·ªô ch√≠nh x√°c t·ªïng s·ªë d∆∞
total_balance = available_balance + held_balance + pending_balance

B·∫•t bi·∫øn 3: T·ªïng giao d·ªãch b·∫±ng s·ªë d∆∞
total_balance == SUM(all transactions.net_amount)

B·∫•t bi·∫øn 4: S·ªë d∆∞ advertiser kh·ªõp chi·∫øn d·ªãch
advertiser.held_balance == SUM(active_campaigns.remaining_budget)

Ki·ªÉm tra:
N·∫æU c√≥ b·∫•t bi·∫øn b·ªã vi ph·∫°m:
  L·ªñI_NGHI√äM_TR·ªåNG: "Vi ph·∫°m to√†n v·∫πn s·ªë d∆∞"
  ƒê√ìNG BƒÇNG v√≠
  C·∫¢NH B√ÅO ƒë·ªôi t√†i ch√≠nh
  K√çCH HO·∫†T ƒë·ªëi so√°t th·ªß c√¥ng
```

---

### Quy t·∫Øc 2: X·ª≠ l√Ω N·∫°p ti·ªÅn

#### 2.1 Gi·ªõi h·∫°n N·∫°p ti·ªÅn

```
Gi·ªõi h·∫°n m·ªói giao d·ªãch:
‚Ä¢ T·ªëi thi·ªÉu: $50.00
‚Ä¢ T·ªëi ƒëa: $10,000.00 m·ªói giao d·ªãch
‚Ä¢ T·ªïng t·ªëi ƒëa h√†ng ng√†y: $50,000.00

Gi·ªõi h·∫°n theo t√†i kho·∫£n:
‚Ä¢ T√†i kho·∫£n ch∆∞a x√°c minh: T·ªëi ƒëa $500/ng√†y
‚Ä¢ T√†i kho·∫£n ƒë√£ x√°c minh: T·ªëi ƒëa $10,000/ng√†y
‚Ä¢ T√†i kho·∫£n doanh nghi·ªáp: Gi·ªõi h·∫°n t√πy ch·ªânh

Gi·ªõi h·∫°n t·∫ßn su·∫•t:
‚Ä¢ T·ªëi ƒëa 10 giao d·ªãch m·ªói ng√†y
‚Ä¢ Cooldown: 1 ph√∫t gi·ªØa c√°c giao d·ªãch

Ki·ªÉm tra:
N·∫æU top_up_amount < 50:
  L·ªñI: "N·∫°p t·ªëi thi·ªÉu $50"

N·∫æU top_up_amount > 10,000:
  L·ªñI: "N·∫°p t·ªëi ƒëa $10,000 m·ªói giao d·ªãch"

N·∫æU daily_total + top_up_amount > daily_limit:
  L·ªñI: "V∆∞·ª£t gi·ªõi h·∫°n h√†ng ng√†y"

N·∫æU transactions_today >= 10:
  L·ªñI: "T·ªëi ƒëa 10 giao d·ªãch m·ªói ng√†y"

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ Gi·ªõi h·∫°n ƒëi·ªÅu ch·ªânh theo c·∫•p t√†i kho·∫£n
‚Ä¢ T√†i kho·∫£n doanh nghi·ªáp c√≥ gi·ªõi h·∫°n t√πy ch·ªânh
‚Ä¢ M·∫´u ƒë√°ng ng·ªù ƒë∆∞·ª£c g·∫Øn c·ªù ƒë·ªÉ ƒë√°nh gi√°
‚Ä¢ Ch·∫°m gi·ªõi h·∫°n li√™n t·ª•c k√≠ch ho·∫°t ƒë√°nh gi√° AML
```

#### 2.2 Lu·ªìng N·∫°p ti·ªÅn

```
Ng∆∞·ªùi th·ª±c hi·ªán: Advertiser
Ph∆∞∆°ng th·ª©c: Th·∫ª t√≠n d·ª•ng, Th·∫ª ghi n·ª£, Chuy·ªÉn kho·∫£n NH

Quy tr√¨nh:
1. User kh·ªüi t·∫°o n·∫°p ti·ªÅn:
   POST /wallet/topup
   {
     "amount": 500.00,
     "payment_method_id": "pm_xxx",
     "save_payment_method": true
   }

2. Ki·ªÉm tra:
   ‚úì amount >= $50 V√Ä <= $10,000
   ‚úì daily_limit kh√¥ng v∆∞·ª£t
   ‚úì payment_method h·ª£p l·ªá v√† active
   ‚úì wallet status = ACTIVE (kh√¥ng ƒë√≥ng bƒÉng)

3. T·∫°o giao d·ªãch pending:
   transaction = WalletTransaction.create(
     wallet_id: wallet.id,
     transaction_type: PENDING_DEPOSIT,
     amount: 500.00,
     status: PENDING,
     payment_method: CREDIT_CARD,
     payment_gateway: STRIPE,
     description: "N·∫°p ti·ªÅn qua Stripe"
   )

   wallet.pending_balance += 500.00

4. X·ª≠ l√Ω thanh to√°n qua gateway:
   // V√≠ d·ª• Stripe
   payment_intent = Stripe.PaymentIntent.create(
     amount: 50000, // cents
     currency: "usd",
     payment_method: payment_method_id,
     confirm: true
   )

5. X·ª≠ l√Ω ph·∫£n h·ªìi gateway:

   Th√†nh c√¥ng (payment_intent.status = "succeeded"):
     wallet.pending_balance -= 500.00
     wallet.available_balance += 500.00

     transaction.update(
       status: COMPLETED,
       gateway_transaction_id: payment_intent.id,
       processed_at: B√ÇY GI·ªú()
     )

     WalletTransaction.create(
       transaction_type: DEPOSIT,
       amount: 500.00,
       balance_before: previous_available,
       balance_after: wallet.available_balance,
       balance_type_affected: AVAILABLE,
       status: COMPLETED
     )

     Th√¥ng b√°o user: "N·∫°p ti·ªÅn th√†nh c√¥ng: $500"

   Th·∫•t b·∫°i (payment_intent.status = "failed"):
     wallet.pending_balance -= 500.00
     // Ho√†n l·∫°i s·ªë d∆∞ pending

     transaction.update(
       status: FAILED,
       processed_at: B√ÇY GI·ªú()
     )

     Th√¥ng b√°o user: "N·∫°p ti·ªÅn th·∫•t b·∫°i: {error_message}"

   Y√™u c·∫ßu H√†nh ƒë·ªông (3D Secure):
     // Tr·∫£ URL ƒë·ªÉ user x√°c th·ª±c
     Return {
       status: "requires_action",
       client_secret: payment_intent.client_secret
     }
     // User ho√†n th√†nh 3DS, webhook x·ª≠ l√Ω k·∫øt qu·∫£

6. Ki·ªÉm tra AML (n·∫øu √°p d·ª•ng):
   N·∫æU amount >= 1,000 HO·∫∂C suspicious_pattern:
     flag_for_aml_review(transaction)

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ Thanh to√°n x·ª≠ l√Ω qua Stripe/PayPal
‚Ä¢ 3D Secure b·∫Øt bu·ªôc cho th·∫ª (quy ƒë·ªãnh ch√¢u √Çu)
‚Ä¢ Pending ‚Üí Available khi thanh to√°n cleared
‚Ä¢ Thanh to√°n th·∫•t b·∫°i ho√†n l·∫°i s·ªë d∆∞ pending
‚Ä¢ T·∫•t c·∫£ giao d·ªãch ƒë∆∞·ª£c log (b·∫•t bi·∫øn)
‚Ä¢ User nh·∫≠n th√¥ng b√°o k·∫øt qu·∫£ (email + push)
```

---

### Quy t·∫Øc 3: Gi·ªØ Ng√¢n s√°ch Chi·∫øn d·ªãch

```
K√≠ch ho·∫°t: Chi·∫øn d·ªãch ƒë∆∞·ª£c t·∫°o v·ªõi ng√¢n s√°ch

Quy tr√¨nh:
1. Ki·ªÉm tra s·ªë d∆∞ kh·∫£ d·ª•ng:
   N·∫æU wallet.available_balance < campaign.budget:
     L·ªñI: "S·ªë d∆∞ kh√¥ng ƒë·ªß"
     Nh·∫Øc user n·∫°p ti·ªÅn

2. T·∫°o giao d·ªãch gi·ªØ:
   WalletTransaction.create(
     transaction_type: CAMPAIGN_HOLD,
     amount: campaign.budget,
     reference_type: "Campaign",
     reference_id: campaign.id,
     description: "Gi·ªØ ng√¢n s√°ch cho chi·∫øn d·ªãch: {campaign.name}",
     status: COMPLETED
   )

3. Chuy·ªÉn ti·ªÅn: available ‚Üí held
   wallet.available_balance -= campaign.budget
   wallet.held_balance += campaign.budget

4. ·∫¢nh h∆∞·ªüng v√≤ng ƒë·ªùi chi·∫øn d·ªãch:

   Khi ghi impression:
     // Tr·ª´ t·ª´ held balance
     impression_cost = calculate_cost(impression)

     wallet.held_balance -= impression_cost
     // Kh√¥ng c·ªông v√†o available (ƒë√£ ti√™u)

     WalletTransaction.create(
       transaction_type: CAMPAIGN_CHARGE,
       amount: impression_cost,
       reference_type: "Impression",
       reference_id: impression.id,
       description: "Chi ph√≠ impression",
       status: COMPLETED
     )

     campaign.spent += impression_cost
     campaign.remaining_budget -= impression_cost

   Khi chi·∫øn d·ªãch ho√†n th√†nh:
     // Gi·∫£i ph√≥ng ng√¢n s√°ch ch∆∞a d√πng
     unused_budget = campaign.remaining_budget

     N·∫æU unused_budget > 0:
       wallet.held_balance -= unused_budget
       wallet.available_balance += unused_budget

       WalletTransaction.create(
         transaction_type: RELEASE,
         amount: unused_budget,
         reference_type: "Campaign",
         reference_id: campaign.id,
         description: "Ng√¢n s√°ch ch∆∞a d√πng ƒë√£ gi·∫£i ph√≥ng",
         status: COMPLETED
       )

   Khi h·ªßy chi·∫øn d·ªãch:
     // Ho√†n ti·ªÅn ƒë·∫ßy ƒë·ªß
     wallet.held_balance -= campaign.remaining_budget
     wallet.available_balance += campaign.remaining_budget

     WalletTransaction.create(
       transaction_type: REFUND,
       amount: campaign.remaining_budget,
       reference_type: "Campaign",
       reference_id: campaign.id,
       description: "Chi·∫øn d·ªãch h·ªßy - ng√¢n s√°ch ho√†n l·∫°i",
       status: COMPLETED
     )

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ Gi·ªØ ng√¢n s√°ch l√† atomic (all-or-nothing)
‚Ä¢ Held balance kh√¥ng d√πng cho chi·∫øn d·ªãch kh√°c
‚Ä¢ Chi ph√≠ impression tr·ª´ t·ª´ held balance
‚Ä¢ Ng√¢n s√°ch ch∆∞a d√πng t·ª± ƒë·ªông gi·∫£i ph√≥ng
‚Ä¢ H·ªßy = ho√†n ti·ªÅn ƒë·∫ßy ƒë·ªß ng√¢n s√°ch c√≤n l·∫°i
‚Ä¢ Giao d·ªãch hold/release ƒë∆∞·ª£c log
```

---

### Quy t·∫Øc 4: Doanh thu & Chi tr·∫£ Supplier

#### 4.1 T√≠ch l≈©y Doanh thu

```
K√≠ch ho·∫°t: Impression ƒë∆∞·ª£c x√°c minh

Quy tr√¨nh:
1. T√≠nh ph·∫ßn c·ªßa supplier:
   impression_cost = 0.08 // V√≠ d·ª•
   platform_share = impression_cost √ó 0.20 = 0.016
   supplier_share = impression_cost √ó 0.80 = 0.064

2. Ghi c√≥ v√≠ supplier (held):
   supplier_wallet.held_balance += supplier_share

   WalletTransaction.create(
     transaction_type: REVENUE,
     amount: supplier_share,
     balance_type_affected: HELD,
     reference_type: "Impression",
     reference_id: impression.id,
     description: "Doanh thu t·ª´ impression",
     status: COMPLETED
   )

3. Th·ªùi gian gi·ªØ: 7 ng√†y (ch·ªëng gian l·∫≠n)
   scheduled_release_date = impression.created_at + 7 ng√†y

4. Sau 7 ng√†y (kh√¥ng tranh ch·∫•p):
   supplier_wallet.held_balance -= supplier_share
   supplier_wallet.available_balance += supplier_share

   WalletTransaction.create(
     transaction_type: RELEASE,
     amount: supplier_share,
     description: "Doanh thu gi·∫£i ph√≥ng sau th·ªùi gian gi·ªØ",
     status: COMPLETED
   )

5. N·∫øu b·ªã tranh ch·∫•p trong 7 ng√†y:
   // Doanh thu ·ªü l·∫°i trong held_balance
   // N·∫øu tranh ch·∫•p gi·ªØ nguy√™n (chargeback):
     supplier_wallet.held_balance -= supplier_share
     // B·ªã tr·ª´ (m·∫•t doanh thu)

     WalletTransaction.create(
       transaction_type: CHARGEBACK,
       amount: supplier_share,
       reference_type: "Dispute",
       reference_id: dispute.id,
       description: "Ho√†n ti·ªÅn cho impression b·ªã tranh ch·∫•p",
       status: COMPLETED
     )

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ Doanh thu ghi c√≥ ngay nh∆∞ng b·ªã gi·ªØ
‚Ä¢ Th·ªùi gian gi·ªØ 7 ng√†y ƒë·ªÉ ph√≤ng gian l·∫≠n
‚Ä¢ T·ª± ƒë·ªông gi·∫£i ph√≥ng sau th·ªùi gian gi·ªØ
‚Ä¢ Doanh thu b·ªã tranh ch·∫•p gi·ªØ cho ƒë·∫øn khi gi·∫£i quy·∫øt
‚Ä¢ Chargeback tr·ª´ t·ª´ held balance
‚Ä¢ Supplier th·∫•y r√µ held vs available
```

#### 4.2 R√∫t ti·ªÅn Supplier

```
Ng∆∞·ªùi th·ª±c hi·ªán: Supplier
T·∫ßn su·∫•t: B·∫•t c·ª© l√∫c n√†o (c√≥ gi·ªõi h·∫°n)

Y√™u c·∫ßu:
‚Ä¢ R√∫t t·ªëi thi·ªÉu: $50.00
‚Ä¢ Available balance >= s·ªë ti·ªÅn r√∫t + ph√≠
‚Ä¢ T√†i kho·∫£n ng√¢n h√†ng ƒë√£ x√°c minh
‚Ä¢ Kh√¥ng c√≥ tranh ch·∫•p ƒëang ch·ªù

Ph√≠ R√∫t ti·ªÅn:
‚Ä¢ < $500: $5 ph√≠
‚Ä¢ $500-$5,000: $10 ph√≠
‚Ä¢ > $5,000: $25 ph√≠

Kh·∫•u tr·ª´ Thu·∫ø (supplier M·ªπ):
‚Ä¢ C√≥ W9: Kh√¥ng kh·∫•u tr·ª´
‚Ä¢ Kh√¥ng c√≥ W9: Kh·∫•u tr·ª´ d·ª± ph√≤ng 24%

Quy tr√¨nh:
1. Supplier y√™u c·∫ßu r√∫t ti·ªÅn:
   POST /wallet/withdraw
   {
     "amount": 1000.00,
     "bank_account_id": "ba_xxx"
   }

2. Ki·ªÉm tra:
   ‚úì amount >= $50
   ‚úì wallet.available_balance >= amount + fee
   ‚úì bank_account ƒë√£ x√°c minh
   ‚úì no_pending_disputes
   ‚úì wallet status = ACTIVE

3. T√≠nh ph√≠ v√† thu·∫ø:
   withdrawal_amount = 1000.00
   fee = 10.00 // Tier $500-$5k
   tax = has_w9 ? 0.00 : (1000.00 √ó 0.24) = 240.00
   net_amount = 1000.00 - 10.00 - 240.00 = 750.00

4. T·∫°o y√™u c·∫ßu r√∫t ti·ªÅn:
   WithdrawalRequest.create(
     wallet_id: wallet.id,
     supplier_id: supplier.id,
     amount: 1000.00,
     fee_amount: 10.00,
     tax_amount: 240.00,
     net_amount: 750.00,
     bank_account_name: "John Doe",
     bank_account_number: "***1234",
     bank_routing_number: "123456789",
     status: PENDING
   )

5. Kh√≥a ti·ªÅn:
   wallet.available_balance -= 1000.00
   wallet.pending_balance += 1000.00

   WalletTransaction.create(
     transaction_type: PENDING_WITHDRAWAL,
     amount: 1000.00,
     balance_type_affected: PENDING,
     status: PENDING,
     description: "Y√™u c·∫ßu r√∫t ti·ªÅn"
   )

6. Duy·ªát admin (t·ª± ƒë·ªông < $5k):
   N·∫æU withdrawal_amount < 5000:
     auto_approve()
   NG∆Ø·ª¢C L·∫†I:
     require_manual_approval()

7. X·ª≠ l√Ω thanh to√°n:
   // Qua Stripe Transfer ho·∫∑c Bank API
   transfer = Stripe.Transfer.create(
     amount: 75000, // cents
     currency: "usd",
     destination: supplier.stripe_account_id
   )

   N·∫æU transfer.status = "paid":
     withdrawal_request.update(
       status: PROCESSING,
       processed_at: B√ÇY GI·ªú()
     )

8. X√°c nh·∫≠n (3-5 ng√†y l√†m vi·ªác):
   // Webhook t·ª´ ng√¢n h√†ng/Stripe
   withdrawal_request.update(
     status: COMPLETED,
     completed_at: B√ÇY GI·ªú(),
     reference_number: bank_reference
   )

   wallet.pending_balance -= 1000.00
   // X√≥a kh·ªèi v√≠

   WalletTransaction.create(
     transaction_type: WITHDRAWAL,
     amount: 1000.00,
     fee_amount: 10.00,
     tax_amount: 240.00,
     net_amount: 750.00,
     status: COMPLETED,
     description: "R√∫t ti·ªÅn ho√†n th√†nh"
   )

   Th√¥ng b√°o supplier: "R√∫t ti·ªÅn ho√†n th√†nh: ${net_amount} ƒë√£ g·ª≠i v·ªÅ NH"

9. X·ª≠ l√Ω l·ªói:
   N·∫æU transfer.status = "failed":
     // Ho√†n l·∫°i available balance
     wallet.pending_balance -= 1000.00
     wallet.available_balance += 1000.00

     withdrawal_request.update(
       status: FAILED,
       failed_at: B√ÇY GI·ªú(),
       failure_reason: transfer.failure_message
     )

     WalletTransaction.create(
       transaction_type: ADJUSTMENT_CREDIT,
       amount: 1000.00,
       description: "R√∫t ti·ªÅn th·∫•t b·∫°i - ƒë√£ ho√†n l·∫°i",
       status: COMPLETED
     )

     Th√¥ng b√°o supplier: "R√∫t ti·ªÅn th·∫•t b·∫°i: {reason}"

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ R√∫t t·ªëi thi·ªÉu $50
‚Ä¢ Ph√≠ r√∫t d·ª±a tr√™n s·ªë ti·ªÅn
‚Ä¢ Kh·∫•u tr·ª´ thu·∫ø n·∫øu kh√¥ng c√≥ form W9
‚Ä¢ Ti·ªÅn b·ªã kh√≥a trong khi x·ª≠ l√Ω (pending_balance)
‚Ä¢ T·ª± ƒë·ªông duy·ªát < $5k, th·ªß c√¥ng >= $5k
‚Ä¢ Th·ªùi gian x·ª≠ l√Ω: 3-5 ng√†y l√†m vi·ªác
‚Ä¢ R√∫t ti·ªÅn th·∫•t b·∫°i t·ª± ƒë·ªông ho√†n l·∫°i
‚Ä¢ T·∫•t c·∫£ b∆∞·ªõc ƒë∆∞·ª£c log v√† ki·ªÉm to√°n ƒë∆∞·ª£c
```

---

### Quy t·∫Øc 5: X·ª≠ l√Ω Ho√†n ti·ªÅn

#### 5.1 C√°c lo·∫°i Ho√†n ti·ªÅn

**Ho√†n ti·ªÅn T·ª± ƒë·ªông**:
```
1. Chi·∫øn d·ªãch H·ªßy (tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu):
   ‚Ä¢ Ho√†n: 100% ng√¢n s√°ch
   ‚Ä¢ X·ª≠ l√Ω: Ngay l·∫≠p t·ª©c

2. Ng√¢n s√°ch Ch∆∞a d√πng (chi·∫øn d·ªãch ho√†n th√†nh):
   ‚Ä¢ Ho√†n: Ng√¢n s√°ch c√≤n l·∫°i
   ‚Ä¢ X·ª≠ l√Ω: T·ª± ƒë·ªông khi ho√†n th√†nh

3. Impression b·ªã Tranh ch·∫•p (chargeback ƒë∆∞·ª£c duy·ªát):
   ‚Ä¢ Ho√†n: Chi ph√≠ impression
   ‚Ä¢ X·ª≠ l√Ω: Sau ƒë√°nh gi√° admin

4. ƒê·∫£o ng∆∞·ª£c Thanh to√°n Th·∫•t b·∫°i:
   ‚Ä¢ Ho√†n: To√†n b·ªô s·ªë ti·ªÅn
   ‚Ä¢ X·ª≠ l√Ω: Ngay l·∫≠p t·ª©c
```

**Ho√†n ti·ªÅn Th·ªß c√¥ng** (y√™u c·∫ßu duy·ªát admin):
```
1. Y√™u c·∫ßu D·ªãch v·ª• Kh√°ch h√†ng:
   ‚Ä¢ User y√™u c·∫ßu ho√†n ti·ªÅn v√¨ nhi·ªÅu l√Ω do
   ‚Ä¢ Admin xem x√©t v√† duy·ªát/t·ª´ ch·ªëi
   ‚Ä¢ X·ª≠ l√Ω: 1-3 ng√†y l√†m vi·ªác

2. L·ªói N·ªÅn t·∫£ng:
   ‚Ä¢ V·∫•n ƒë·ªÅ k·ªπ thu·∫≠t g√¢y t√≠nh ph√≠ sai
   ‚Ä¢ Admin kh·ªüi t·∫°o ho√†n ti·ªÅn
   ‚Ä¢ X·ª≠ l√Ω: Ngay l·∫≠p t·ª©c

3. Ho√†n ti·ªÅn M·ªôt ph·∫ßn:
   ‚Ä¢ Gi·∫£i quy·∫øt cho tranh ch·∫•p
   ‚Ä¢ Admin ch·ªâ ƒë·ªãnh s·ªë ti·ªÅn
   ‚Ä¢ X·ª≠ l√Ω: 1-3 ng√†y l√†m vi·ªác
```

#### 5.2 Quy tr√¨nh Ho√†n ti·ªÅn

```
∆Øu ti√™n Ph∆∞∆°ng th·ª©c Ho√†n ti·ªÅn:
1. Ph∆∞∆°ng th·ª©c thanh to√°n g·ªëc (n·∫øu < 90 ng√†y)
2. S·ªë d∆∞ v√≠ (n·∫øu ph∆∞∆°ng th·ª©c thanh to√°n th·∫•t b·∫°i)
3. Chuy·ªÉn kho·∫£n NH (n·∫øu ph∆∞∆°ng th·ª©c thanh to√°n kh√¥ng kh·∫£ d·ª•ng)

Quy tr√¨nh:
1. T·∫°o y√™u c·∫ßu ho√†n ti·ªÅn:
   RefundRequest.create(
     wallet_id: wallet.id,
     advertiser_id: advertiser.id,
     campaign_id: campaign.id,
     amount: refund_amount,
     refund_type: type,
     reason: reason,
     status: PENDING
   )

2. Ki·ªÉm tra:
   ‚úì S·ªë ti·ªÅn h·ª£p l·ªá (> 0, <= giao d·ªãch g·ªëc)
   ‚úì Giao d·ªãch g·ªëc t·ªìn t·∫°i
   ‚úì Ch∆∞a ho√†n ti·ªÅn
   ‚úì Trong c·ª≠a s·ªï ho√†n ti·ªÅn (90 ng√†y cho gateway)

3. Duy·ªát (t·ª± ƒë·ªông ho·∫∑c th·ªß c√¥ng):
   N·∫æU auto_refund_eligible(refund_request):
     approve_automatically()
   NG∆Ø·ª¢C L·∫†I:
     assign_to_admin_for_review()

4. X·ª≠ l√Ω ho√†n ti·ªÅn:

   T√πy ch·ªçn A: Ho√†n gateway (< 90 ng√†y)
     gateway_refund = Stripe.Refund.create(
       charge: original_charge_id,
       amount: refund_amount_cents
     )

     N·∫æU gateway_refund.status = "succeeded":
       wallet.pending_balance += refund_amount
       // S·∫Ω available khi cleared (1-3 ng√†y)

       WalletTransaction.create(
         transaction_type: REFUND,
         amount: refund_amount,
         payment_gateway: STRIPE,
         gateway_transaction_id: gateway_refund.id,
         status: PENDING,
         description: "Ho√†n v·ªÅ ph∆∞∆°ng th·ª©c thanh to√°n g·ªëc"
       )

   T√πy ch·ªçn B: Ho√†n s·ªë d∆∞ v√≠
     wallet.available_balance += refund_amount

     WalletTransaction.create(
       transaction_type: REFUND,
       amount: refund_amount,
       status: COMPLETED,
       description: "Ho√†n ti·ªÅn ghi c√≥ v√†o v√≠"
     )

5. X√°c nh·∫≠n:
   refund_request.update(
     status: COMPLETED,
     processed_at: B√ÇY GI·ªú()
   )

   Th√¥ng b√°o advertiser: "Ho√†n ti·ªÅn ƒë√£ x·ª≠ l√Ω: ${amount}"

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ ∆Øu ti√™n ho√†n v·ªÅ ph∆∞∆°ng th·ª©c thanh to√°n g·ªëc
‚Ä¢ Ghi c√≥ v√≠ n·∫øu ph∆∞∆°ng th·ª©c thanh to√°n kh√¥ng kh·∫£ d·ª•ng
‚Ä¢ Ho√†n ti·ªÅn < $1000: t·ª± ƒë·ªông duy·ªát
‚Ä¢ Ho√†n ti·ªÅn >= $1000: y√™u c·∫ßu duy·ªát admin
‚Ä¢ C·ª≠a s·ªï 90 ng√†y cho ho√†n gateway
‚Ä¢ Sau 90 ng√†y: ch·ªâ ghi c√≥ v√≠
‚Ä¢ T·∫•t c·∫£ ho√†n ti·ªÅn ƒë∆∞·ª£c log v√† ki·ªÉm to√°n
‚Ä¢ Ph√≠ ho√†n ti·ªÅn: kh√¥ng c√≥ (n·ªÅn t·∫£ng ch·ªãu)
```

---

## üí± Ti·ªÅn t·ªá & T·ª∑ gi√°

### Quy t·∫Øc 6: H·ªó tr·ª£ ƒêa ti·ªÅn t·ªá

```
C√°c lo·∫°i ti·ªÅn h·ªó tr·ª£:
‚Ä¢ USD (United States Dollar)
‚Ä¢ EUR (Euro)
‚Ä¢ GBP (British Pound)
‚Ä¢ VND (Vietnamese Dong)
‚Ä¢ ... (c√≥ th·ªÉ c·∫•u h√¨nh)

Ti·ªÅn t·ªá M·∫∑c ƒë·ªãnh:
‚Ä¢ D·ª±a tr√™n qu·ªëc gia c·ªßa user
‚Ä¢ User M·ªπ: USD
‚Ä¢ User Vi·ªát Nam: VND
‚Ä¢ User EU: EUR

Chuy·ªÉn ƒë·ªïi:
‚Ä¢ T·ª∑ gi√° th·ªùi gian th·ª±c t·ª´ nh√† cung c·∫•p (vd: OpenExchangeRates.org)
‚Ä¢ T·ª∑ gi√° cache 1 gi·ªù
‚Ä¢ Chuy·ªÉn ƒë·ªïi t·∫°i th·ªùi ƒëi·ªÉm giao d·ªãch (kh√¥ng ph·∫£i hi·ªÉn th·ªã)

Quy tr√¨nh:
1. User xem s·ªë d∆∞:
   Hi·ªÉn th·ªã theo wallet.currency

2. N·∫°p ti·ªÅn b·∫±ng ti·ªÅn t·ªá kh√°c:
   User tr·∫£: ‚Ç¨100 EUR
   V√≠ user: USD

   conversion_rate = get_rate("EUR", "USD") // 1.08
   usd_amount = 100 √ó 1.08 = 108.00

   wallet.available_balance += 108.00 USD

   WalletTransaction.create(
     amount: 108.00,
     currency: "USD",
     metadata: {
       original_amount: 100.00,
       original_currency: "EUR",
       exchange_rate: 1.08
     }
   )

3. Chi·∫øn d·ªãch ƒëa ti·ªÅn t·ªá:
   Ti·ªÅn t·ªá chi·∫øn d·ªãch: VND
   V√≠ advertiser: USD

   impression_cost_vnd = 100,000 VND
   conversion_rate = get_rate("VND", "USD") // 0.000041
   impression_cost_usd = 100,000 √ó 0.000041 = 4.10 USD

   Tr·ª´ 4.10 USD t·ª´ v√≠

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ V√≠ c√≥ ƒë∆°n ti·ªÅn t·ªá (kh√¥ng c√≥ v√≠ ƒëa ti·ªÅn t·ªá)
‚Ä¢ Chuy·ªÉn ƒë·ªïi t·∫°i th·ªùi ƒëi·ªÉm giao d·ªãch
‚Ä¢ T·ª∑ gi√° l∆∞u trong metadata giao d·ªãch
‚Ä¢ T·ª∑ gi√° c·∫≠p nh·∫≠t m·ªói gi·ªù
‚Ä¢ Ph√≠ chuy·ªÉn ƒë·ªïi: kh√¥ng c√≥ (ƒë√£ bao g·ªìm trong t·ª∑ gi√°)
‚Ä¢ User c√≥ th·ªÉ xem ∆∞·ªõc t√≠nh chuy·ªÉn ƒë·ªïi trong dashboard
```

---

## üíº X·ª≠ l√Ω Thu·∫ø

### Quy t·∫Øc 7: T√≠nh thu·∫ø & Kh·∫•u tr·ª´

#### 7.1 Thu·∫ø Doanh thu (cho Advertiser)

```
√Åp d·ª•ng:
‚Ä¢ Advertiser ·ªü M·ªπ: Thu·∫ø doanh thu ti·ªÉu bang tr√™n chi ti√™u qu·∫£ng c√°o
‚Ä¢ Advertiser ·ªü EU: VAT tr√™n d·ªãch v·ª•
‚Ä¢ C√°c khu v·ª±c kh√°c: Theo lu·∫≠t thu·∫ø ƒë·ªãa ph∆∞∆°ng

X√°c ƒë·ªãnh Thu·∫ø su·∫•t:
‚Ä¢ D·ª±a tr√™n ƒë·ªãa ch·ªâ thanh to√°n advertiser
‚Ä¢ Tra c·ª©u thu·∫ø su·∫•t t·ª´ TaxJar API ho·∫∑c t∆∞∆°ng t·ª±
‚Ä¢ C·∫≠p nh·∫≠t h√†ng th√°ng

T√≠nh to√°n:
campaign_budget = 1000.00
tax_rate = get_tax_rate(advertiser.billing_address) // vd: 8.25%
tax_amount = 1000.00 √ó 0.0825 = 82.50
total_charge = 1000.00 + 82.50 = 1082.50

// User tr·∫£ total_charge
// Ng√¢n s√°ch chi·∫øn d·ªãch = 1000.00 (tr∆∞·ªõc thu·∫ø)
// Thu·∫ø n·ªôp cho c∆° quan

WalletTransaction.create(
  transaction_type: TAX_WITHHOLDING,
  amount: 82.50,
  description: "Thu·∫ø doanh thu (8.25%)",
  metadata: {
    tax_type: "SALES_TAX",
    tax_rate: 0.0825,
    jurisdiction: "California"
  }
)

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ Thu·∫ø t√≠nh khi t·∫°o chi·∫øn d·ªãch
‚Ä¢ Thu·∫ø hi·ªÉn th·ªã ri√™ng trong h√≥a ƒë∆°n
‚Ä¢ Thu·∫ø n·ªôp cho c∆° quan h√†ng th√°ng
‚Ä¢ T√†i kho·∫£n mi·ªÖn thu·∫ø (c√≥ gi·∫•y ch·ª©ng nh·∫≠n) ƒë∆∞·ª£c mi·ªÖn
```

#### 7.2 Kh·∫•u tr·ª´ Thu·∫ø (cho Supplier)

```
√Åp d·ª•ng:
‚Ä¢ Supplier M·ªπ kh√¥ng c√≥ form W-9: Kh·∫•u tr·ª´ d·ª± ph√≤ng 24%
‚Ä¢ Supplier ngo√†i M·ªπ: Kh·∫•u tr·ª´ 30% (tr·ª´ khi c√≥ hi·ªáp ƒë·ªãnh)

Kh·∫•u tr·ª´ khi Thanh to√°n:
supplier_revenue = 1000.00

N·∫æU supplier.has_w9:
  withholding = 0.00
NG∆Ø·ª¢C L·∫†I N·∫æU supplier.country = "US":
  withholding = 1000.00 √ó 0.24 = 240.00
NG∆Ø·ª¢C L·∫†I N·∫æU supplier.country TRONG tax_treaty_countries:
  withholding = 1000.00 √ó treaty_rate
NG∆Ø·ª¢C L·∫†I:
  withholding = 1000.00 √ó 0.30 = 300.00

net_payout = 1000.00 - withholding

WalletTransaction.create(
  transaction_type: TAX_WITHHOLDING,
  amount: withholding,
  description: "Kh·∫•u tr·ª´ thu·∫ø (24%)",
  metadata: {
    tax_type: "BACKUP_WITHHOLDING",
    tax_rate: 0.24
  }
)

// Supplier nh·∫≠n net_payout
// Withholding n·ªôp cho IRS

B√°o c√°o cu·ªëi nƒÉm:
‚Ä¢ Form 1099 ph√°t h√†nh cho supplier M·ªπ
‚Ä¢ Form 1042-S ph√°t h√†nh cho supplier ngo√†i M·ªπ
‚Ä¢ T·ªïng kh·∫•u tr·ª´ + t·ªïng tr·∫£ ƒë∆∞·ª£c b√°o c√°o

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ Kh·∫•u tr·ª´ √°p d·ª•ng khi r√∫t ti·ªÅn
‚Ä¢ N·ªôp W-9 ng·ª´ng kh·∫•u tr·ª´
‚Ä¢ T√¥n tr·ªçng thu·∫ø su·∫•t theo hi·ªáp ƒë·ªãnh
‚Ä¢ S·ªë ti·ªÅn kh·∫•u tr·ª´ b√°o c√°o cho c∆° quan thu·∫ø
‚Ä¢ Form ph√°t h√†nh tr∆∞·ªõc 31 th√°ng 1
```

---

## üìä ƒê·ªëi so√°t T√†i ch√≠nh

### Quy t·∫Øc 8: ƒê·ªëi so√°t H√†ng ng√†y

```
L·ªãch tr√¨nh: H√†ng ng√†y l√∫c 00:00 UTC

M·ª•c ƒë√≠ch: X√°c minh ƒë·ªô ch√≠nh x√°c t√†i ch√≠nh

Quy tr√¨nh:
1. T√≠nh t·ªïng d·ª± ki·∫øn:
   expected_balance = (
     opening_balance +
     total_deposits -
     total_withdrawals -
     total_fees
   )

2. T√≠nh t·ªïng th·ª±c t·∫ø:
   actual_balance = SUM(
     wallet.available_balance +
     wallet.held_balance +
     wallet.pending_balance
     CHO T·∫§T C·∫¢ v√≠
   )

3. So s√°nh:
   discrepancy = expected_balance - actual_balance

4. Ki·ªÉm tra giao d·ªãch:
   transaction_sum = SUM(
     transactions.net_amount
     WHERE date = yesterday
   )

   N·∫æU transaction_sum != (deposits - withdrawals - fees):
     G·∫ÆN C·ªú discrepancy

5. Ghi nh·∫≠n ƒë·ªëi so√°t:
   DailyReconciliation.create(
     reconciliation_date: yesterday,
     total_deposits: deposits,
     total_withdrawals: withdrawals,
     expected_balance: expected_balance,
     actual_balance: actual_balance,
     discrepancy: discrepancy,
     status: discrepancy == 0 ? BALANCED : DISCREPANCY
   )

6. C·∫£nh b√°o n·∫øu c√≥ l·ªách:
   N·∫æU abs(discrepancy) > 0.01: // > 1 cent
     send_alert(finance_team, "L·ªách ƒë·ªëi so√°t: ${discrepancy}")
     require_investigation()

7. ƒêi·ªÅu tra:
   ‚Ä¢ Xem x√©t t·∫•t c·∫£ giao d·ªãch c·ªßa h√¥m qua
   ‚Ä¢ Ki·ªÉm tra giao d·ªãch th·∫•t b·∫°i/pending
   ‚Ä¢ X√°c minh webhook gateway ƒë√£ nh·∫≠n
   ‚Ä¢ Ki·ªÉm tra race condition
   ‚Ä¢ Ki·ªÉm to√°n th·ªß c√¥ng n·∫øu c·∫ßn

8. Gi·∫£i quy·∫øt:
   N·∫æU discrepancy_resolved:
     DailyReconciliation.update(
       status: RESOLVED,
       discrepancy_reason: explanation,
       reconciled_by: admin.id,
       reconciled_at: B√ÇY GI·ªú()
     )

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ ƒê·ªëi so√°t ch·∫°y t·ª± ƒë·ªông h√†ng ng√†y
‚Ä¢ L·ªách ƒë∆∞·ª£c ƒëi·ªÅu tra ngay l·∫≠p t·ª©c
‚Ä¢ Ch·∫•p nh·∫≠n ¬±$0.01 (l·ªói l√†m tr√≤n)
‚Ä¢ L·ªách l·ªõn h∆°n d·ª´ng ho·∫°t ƒë·ªông cho ƒë·∫øn khi gi·∫£i quy·∫øt
‚Ä¢ T·∫•t c·∫£ ƒë·ªëi so√°t c√≥ th·ªÉ ki·ªÉm to√°n
‚Ä¢ ƒê·ªëi so√°t h√†ng th√°ng t·ªïng h·ª£p k·∫øt qu·∫£ h√†ng ng√†y
```

---

## üõ°Ô∏è Ch·ªëng R·ª≠a ti·ªÅn (AML)

### Quy t·∫Øc 9: Tu√¢n th·ªß AML

#### 9.1 Gi√°m s√°t Giao d·ªãch

```
Ch·ªâ b√°o Ho·∫°t ƒë·ªông ƒê√°ng ng·ªù:

1. Giao d·ªãch ƒê∆°n L·ªõn:
   N·∫æU deposit >= $10,000:
     flag_for_aml_review("N·∫°p ti·ªÅn l·ªõn")

2. C·∫•u tr√∫c h√≥a (Smurfing):
   deposits_today = SUM(deposits WHERE date = today)
   N·∫æU deposits_today >= $10,000:
     V√Ä max_single_deposit < $5,000:
       flag_for_aml_review("C√≥ th·ªÉ c·∫•u tr√∫c h√≥a")

3. Ra v√†o Nhanh:
   N·∫æU deposit_today > $5,000:
     V√Ä withdrawal_within_24h > $4,000:
       flag_for_aml_review("Ra v√†o nhanh")

4. M·∫´u B·∫•t th∆∞·ªùng:
   N·∫æU typical_monthly_deposit < $1,000:
     V√Ä current_deposit > $10,000:
       flag_for_aml_review("M·∫´u b·∫•t th∆∞·ªùng")

5. Khu v·ª±c R·ªßi ro Cao:
   N·∫æU user.country TRONG high_risk_countries:
     flag_for_aml_review("Khu v·ª±c r·ªßi ro cao")

H√†nh ƒë·ªông khi G·∫Øn c·ªù:
1. Giao d·ªãch b·ªã gi·ªØ (pending_balance)
2. ƒê·ªôi tu√¢n th·ªß ƒë∆∞·ª£c th√¥ng b√°o
3. Y√™u c·∫ßu t√†i li·ªáu b·ªï sung:
   ‚Ä¢ Ngu·ªìn ti·ªÅn
   ‚Ä¢ L√Ω do kinh doanh
   ‚Ä¢ X√°c minh danh t√≠nh
4. ƒê√°nh gi√° trong 24-48 gi·ªù
5. Duy·ªát ho·∫∑c t·ª´ ch·ªëi

Duy·ªát:
  Gi·∫£i ph√≥ng ti·ªÅn v·ªÅ available_balance
  X√≥a c·ªù

T·ª´ ch·ªëi:
  Ho√†n ti·ªÅn v·ªÅ ngu·ªìn thanh to√°n
  ƒê√≥ng t√†i kho·∫£n n·∫øu vi ph·∫°m l·∫∑p l·∫°i
```

#### 9.2 Bi·∫øt Kh√°ch h√†ng c·ªßa B·∫°n (KYC)

```
C√°c c·∫•p X√°c minh:

C·∫•p 1 (C∆° b·∫£n):
‚Ä¢ Email ƒë√£ x√°c minh
‚Ä¢ Gi·ªõi h·∫°n: $500/ng√†y
‚Ä¢ Y√™u c·∫ßu: Ch·ªâ email

C·∫•p 2 (ƒê√£ x√°c minh):
‚Ä¢ Danh t√≠nh ƒë√£ x√°c minh (gi·∫•y t·ªù ID)
‚Ä¢ Gi·ªõi h·∫°n: $10,000/ng√†y
‚Ä¢ Y√™u c·∫ßu: ID ch√≠nh ph·ªß + ·∫¢nh selfie

C·∫•p 3 (Doanh nghi·ªáp):
‚Ä¢ Doanh nghi·ªáp ƒë√£ x√°c minh
‚Ä¢ Gi·ªõi h·∫°n: T√πy ch·ªânh
‚Ä¢ Y√™u c·∫ßu: ƒêƒÉng k√Ω KD + M√£ s·ªë thu·∫ø

Quy tr√¨nh X√°c minh:
1. User upload t√†i li·ªáu
2. D·ªãch v·ª• x√°c minh danh t√≠nh (vd: Stripe Identity)
3. Ki·ªÉm tra t·ª± ƒë·ªông:
   ‚Ä¢ T√≠nh x√°c th·ª±c t√†i li·ªáu
   ‚Ä¢ Kh·ªõp khu√¥n m·∫∑t
   ‚Ä¢ Ki·ªÉm tra database (danh s√°ch tr·ª´ng ph·∫°t, PEP)
4. ƒê√°nh gi√° th·ªß c√¥ng n·∫øu g·∫Øn c·ªù
5. Duy·ªát c·∫•p gi·ªõi h·∫°n cao h∆°n

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ T√†i kho·∫£n ch∆∞a x√°c minh gi·ªõi h·∫°n $500/ng√†y
‚Ä¢ X√°c minh b·∫Øt bu·ªôc cho gi·ªõi h·∫°n cao h∆°n
‚Ä¢ X√°c minh l·∫°i m·ªói 2 nƒÉm
‚Ä¢ Due diligence n√¢ng cao cho >$50k/th√°ng
‚Ä¢ PEP (Politically Exposed Person) g·∫Øn c·ªù ƒë·ªÉ ƒë√°nh gi√°
‚Ä¢ Ki·ªÉm tra danh s√°ch tr·ª´ng ph·∫°t t·ª± ƒë·ªông
```

---

## ‚ö†Ô∏è C√°c tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát

### Tr∆∞·ªùng h·ª£p 1: N·∫°p ti·ªÅn ƒê·ªìng th·ªùi

```
T√¨nh hu·ªëng: User g·ª≠i 2 y√™u c·∫ßu n·∫°p ti·ªÅn c√πng l√∫c

Race Condition:
  Giao d·ªãch A: N·∫°p $500
  Giao d·ªãch B: N·∫°p $500
  Gi·ªõi h·∫°n h√†ng ng√†y: $1,000

Kh√¥ng c√≥ lock:
  C·∫£ hai ki·ªÉm tra daily_total = $0
  C·∫£ hai ti·∫øp t·ª•c (t·ªïng = $1,000) ‚Üí OK
  Nh∆∞ng n·∫øu Giao d·ªãch C c≈©ng: t·ªïng = $1,500 ‚Üí VI PH·∫†M

Gi·∫£i ph√°p: Kh√≥a c·∫•p database
BEGIN TRANSACTION;
SELECT available_balance FROM wallets
WHERE id = X
FOR UPDATE; // Kh√≥a c·∫•p row

daily_total = get_daily_total_with_lock(user_id)
N·∫æU daily_total + amount > daily_limit:
  ROLLBACK;
  L·ªñI: "V∆∞·ª£t gi·ªõi h·∫°n h√†ng ng√†y"
NG∆Ø·ª¢C L·∫†I:
  wallet.available_balance += amount
  COMMIT;

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ D√πng kh√≥a c·∫•p row cho c·∫≠p nh·∫≠t s·ªë d∆∞
‚Ä¢ Thao t√°c atomic (all-or-nothing)
‚Ä¢ Th·ª≠ l·∫°i giao d·ªãch th·∫•t b·∫°i (exponential backoff)
```

### Tr∆∞·ªùng h·ª£p 2: Tr–∑–∞–¥–µ—Ä–∂–∫–∞ Webhook C·ªïng thanh to√°n

```
T√¨nh hu·ªëng: Thanh to√°n th√†nh c√¥ng nh∆∞ng webhook b·ªã tr·ªÖ

Timeline:
  T+0s: User g·ª≠i n·∫°p ti·ªÅn
  T+1s: Thanh to√°n th√†nh c√¥ng t·∫°i Stripe
  T+2s: Giao d·ªãch pending ƒë∆∞·ª£c t·∫°o
  T+3600s: Webhook ƒë·∫øn (tr·ªÖ 1 gi·ªù)

V·∫•n ƒë·ªÅ: S·ªë d∆∞ user hi·ªÉn th·ªã pending trong 1 gi·ªù

Gi·∫£i ph√°p: Webhook + Polling K·∫øt h·ª£p
1. T·∫°o giao d·ªãch pending ngay l·∫≠p t·ª©c
2. Poll tr·∫°ng th√°i thanh to√°n m·ªói 30 gi√¢y (timeout: 5 ph√∫t)
3. N·∫øu status = succeeded:
     X·ª≠ l√Ω ngay (kh√¥ng ƒë·ª£i webhook)
4. Webhook l√† backup/x√°c nh·∫≠n

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ Poll t·ªëi ƒëa 5 ph√∫t
‚Ä¢ Webhook l√† ngu·ªìn ch√¢n l√Ω (ghi ƒë√® poll n·∫øu xung ƒë·ªôt)
‚Ä¢ C·∫£nh b√°o n·∫øu webhook kh√¥ng nh·∫≠n trong 1 gi·ªù
```

### Tr∆∞·ªùng h·ª£p 3: T√†i kho·∫£n NH R√∫t ti·ªÅn B·ªã ƒë√≥ng

```
T√¨nh hu·ªëng: TK ng√¢n h√†ng supplier ƒë√≥ng, r√∫t ti·ªÅn th·∫•t b·∫°i

Quy tr√¨nh:
1. R√∫t ti·ªÅn kh·ªüi t·∫°o:
   wallet.available_balance -= 1000
   wallet.pending_balance += 1000

2. Th·ª≠ chuy·ªÉn kho·∫£n ng√¢n h√†ng
3. Ng√¢n h√†ng tr·∫£ l·ªói: "T√†i kho·∫£n ƒë√≥ng"

4. X·ª≠ l√Ω l·ªói:
   wallet.pending_balance -= 1000
   wallet.available_balance += 1000

   withdrawal_request.update(
     status: FAILED,
     failure_reason: "T√†i kho·∫£n ng√¢n h√†ng ƒë√≥ng"
   )

   Th√¥ng b√°o supplier: "R√∫t ti·ªÅn th·∫•t b·∫°i - vui l√≤ng c·∫≠p nh·∫≠t TK NH"

5. Supplier c·∫≠p nh·∫≠t TK ng√¢n h√†ng
6. Th·ª≠ r√∫t ti·ªÅn l·∫°i

Quy t·∫Øc nghi·ªáp v·ª•:
‚Ä¢ R√∫t ti·ªÅn th·∫•t b·∫°i t·ª± ƒë·ªông ho√†n l·∫°i
‚Ä¢ User nh·∫≠n th√¥ng b√°o v·ªõi l√Ω do c·ª• th·ªÉ
‚Ä¢ C√≥ th·ªÉ th·ª≠ l·∫°i sau khi c·∫≠p nh·∫≠t th√¥ng tin NH
‚Ä¢ T·ªëi ƒëa 3 l·∫ßn th·ª≠ l·∫°i
‚Ä¢ Sau 3 l·∫ßn th·∫•t b·∫°i: y√™u c·∫ßu can thi·ªáp th·ªß c√¥ng
```

---

## ‚úÖ Quy t·∫Øc Ki·ªÉm tra

### Ma tr·∫≠n Ki·ªÉm tra V√≠

| Tr∆∞·ªùng | Quy t·∫Øc | Th√¥ng b√°o l·ªói |
|--------|---------|---------------|
| `amount` | > 0 | "S·ªë ti·ªÅn ph·∫£i d∆∞∆°ng" |
| `amount` | T·ªëi ƒëa 2 s·ªë th·∫≠p ph√¢n | "S·ªë ti·ªÅn kh√¥ng th·ªÉ c√≥ qu√° 2 s·ªë th·∫≠p ph√¢n" |
| `top_up_amount` | >= $50 | "N·∫°p t·ªëi thi·ªÉu $50" |
| `top_up_amount` | <= $10,000 | "N·∫°p t·ªëi ƒëa $10,000 m·ªói giao d·ªãch" |
| `withdrawal_amount` | >= $50 | "R√∫t t·ªëi thi·ªÉu $50" |
| `withdrawal_amount` | <= available_balance | "S·ªë d∆∞ kh√¥ng ƒë·ªß" |
| `currency` | M√£ ISO 4217 | "M√£ ti·ªÅn t·ªá kh√¥ng h·ª£p l·ªá" |
| `balance` | >= 0 | "S·ªë d∆∞ kh√¥ng th·ªÉ √¢m" |

---

## üßÆ C√¥ng th·ª©c T√≠nh to√°n

### T·ªïng h·ª£p C√¥ng th·ª©c

#### 1. T·ªïng S·ªë d∆∞

```
total_balance = available_balance + held_balance + pending_balance

Ph·∫£i b·∫±ng: SUM(all transactions.net_amount)
```

#### 2. S·ªë ti·ªÅn Giao d·ªãch R√≤ng

```
net_amount = amount - fee_amount - tax_amount

V√≠ d·ª•:
  R√∫t ti·ªÅn: $1,000
  Ph√≠: $10
  Thu·∫ø: $240
  R√≤ng: $1,000 - $10 - $240 = $750
```

#### 3. Ph·∫ßn Doanh thu Supplier

```
supplier_revenue = impression_cost √ó 0.80
platform_revenue = impression_cost √ó 0.20

V√≠ d·ª•:
  Chi ph√≠ impression: $0.10
  Supplier: $0.08
  N·ªÅn t·∫£ng: $0.02
```

#### 4. ƒê·ªëi so√°t H√†ng ng√†y

```
expected_balance = (
  opening_balance +
  SUM(deposits) -
  SUM(withdrawals) -
  SUM(fees) -
  SUM(taxes)
)

discrepancy = expected_balance - actual_balance

Ch·∫•p nh·∫≠n n·∫øu: abs(discrepancy) <= $0.01
```

#### 5. Ph√≠ R√∫t ti·ªÅn

```
fee = CASE withdrawal_amount
  KHI < $500: $5
  KHI $500-$5,000: $10
  KHI > $5,000: $25
```

#### 6. Kh·∫•u tr·ª´ Thu·∫ø

```
Supplier M·ªπ kh√¥ng c√≥ W-9:
  withholding = amount √ó 0.24

Supplier ngo√†i M·ªπ kh√¥ng c√≥ hi·ªáp ƒë·ªãnh:
  withholding = amount √ó 0.30

C√≥ hi·ªáp ƒë·ªãnh:
  withholding = amount √ó treaty_rate
```

---

## üìö Ph·ª• l·ª•c: V√≠ d·ª• Giao d·ªãch

### V√≠ d·ª• 1: Lu·ªìng N·∫°p ti·ªÅn Ho√†n ch·ªânh

```
Tr·∫°ng th√°i ban ƒë·∫ßu:
  available_balance: $100.00

1. User n·∫°p $500:
   pending_balance += $500 ‚Üí $500.00
   Giao d·ªãch: PENDING_DEPOSIT, $500

2. Thanh to√°n cleared:
   pending_balance -= $500 ‚Üí $0.00
   available_balance += $500 ‚Üí $600.00
   Giao d·ªãch: DEPOSIT, $500

Tr·∫°ng th√°i cu·ªëi:
  available_balance: $600.00
  S·ªë giao d·ªãch: 2
```

### V√≠ d·ª• 2: Lu·ªìng Ng√¢n s√°ch Chi·∫øn d·ªãch

```
Tr·∫°ng th√°i ban ƒë·∫ßu:
  available_balance: $600.00

1. T·∫°o chi·∫øn d·ªãch (ng√¢n s√°ch $500):
   available_balance -= $500 ‚Üí $100.00
   held_balance += $500 ‚Üí $500.00
   Giao d·ªãch: CAMPAIGN_HOLD, $500

2. Ghi impression ($300 chi):
   held_balance -= $300 ‚Üí $200.00
   Giao d·ªãch: CAMPAIGN_CHARGE √ó N (t·ªïng $300)

3. Chi·∫øn d·ªãch ho√†n th√†nh ($200 ch∆∞a d√πng):
   held_balance -= $200 ‚Üí $0.00
   available_balance += $200 ‚Üí $300.00
   Giao d·ªãch: RELEASE, $200

Tr·∫°ng th√°i cu·ªëi:
  available_balance: $300.00
  held_balance: $0.00
  Chi chi·∫øn d·ªãch: $300
```

### V√≠ d·ª• 3: Lu·ªìng Thanh to√°n Supplier

```
Tr·∫°ng th√°i ban ƒë·∫ßu:
  available_balance: $1,000.00

1. Y√™u c·∫ßu r√∫t $1,000:
   available_balance -= $1,000 ‚Üí $0.00
   pending_balance += $1,000 ‚Üí $1,000.00
   Giao d·ªãch: PENDING_WITHDRAWAL, $1,000

2. Tr·ª´ ph√≠ v√† thu·∫ø:
   Ph√≠: $10
   Thu·∫ø (kh√¥ng c√≥ W-9): $240
   R√≤ng: $750

3. Wire ƒë√£ g·ª≠i:
   pending_balance -= $1,000 ‚Üí $0.00
   Giao d·ªãch: WITHDRAWAL, $1,000
   Giao d·ªãch: FEE, $10
   Giao d·ªãch: TAX_WITHHOLDING, $240

Tr·∫°ng th√°i cu·ªëi:
  available_balance: $0.00
  pending_balance: $0.00
  Ng√¢n h√†ng nh·∫≠n: $750
```

---

## üìö B·∫£ng thu·∫≠t ng·ªØ

| Thu·∫≠t ng·ªØ | ƒê·ªãnh nghƒ©a |
|-----------|------------|
| **Wallet (V√≠)** | T√†i kho·∫£n k·ªπ thu·∫≠t s·ªë ch·ª©a ti·ªÅn |
| **Available Balance** | Ti·ªÅn c√≥ th·ªÉ d√πng ngay |
| **Held Balance** | Ti·ªÅn b·ªã kh√≥a t·∫°m th·ªùi (k√Ω qu·ªπ) |
| **Pending Balance** | Ti·ªÅn ƒëang x·ª≠ l√Ω (n·∫°p/r√∫t) |
| **Top-up** | N·∫°p ti·ªÅn v√†o v√≠ |
| **Withdrawal** | R√∫t ti·ªÅn t·ª´ v√≠ v·ªÅ ng√¢n h√†ng |
| **Transaction** | B·∫£n ghi thay ƒë·ªïi s·ªë d∆∞ |
| **Gateway** | C·ªïng thanh to√°n (Stripe, PayPal) |
| **Reconciliation** | ƒê·ªëi so√°t t√†i ch√≠nh |
| **AML** | Anti-Money Laundering (Ch·ªëng r·ª≠a ti·ªÅn) |
| **KYC** | Know Your Customer (Bi·∫øt kh√°ch h√†ng) |
| **Chargeback** | Ho√†n ti·ªÅn tranh ch·∫•p |

---

## üìö Tham kh·∫£o

### T√†i li·ªáu li√™n quan

| T√†i li·ªáu | M√¥ t·∫£ |
|----------|-------|
| [T·ª´ ƒëi·ªÉn Thu·∫≠t ng·ªØ](./00-tu-dien-thuat-ngu.md) | Gi·∫£i th√≠ch t·∫•t c·∫£ thu·∫≠t ng·ªØ |
| [Quy t·∫Øc Chi·∫øn d·ªãch](./04-quy-tac-chien-dich.md) | Qu·∫£n l√Ω ng√¢n s√°ch chi·∫øn d·ªãch |
| [Quy t·∫Øc Advertiser](./08-quy-tac-nha-quang-cao.md) | T√†i kho·∫£n & v√≠ advertiser |
| [Quy t·∫Øc Supplier](./09-quy-tac-nha-cung-cap.md) | Doanh thu & thanh to√°n supplier |

---

**Phi√™n b·∫£n**: 1.0  
**C·∫≠p nh·∫≠t l·∫ßn cu·ªëi**: 2026-01-23  
**Ng∆∞·ªùi ph·ª• tr√°ch**: Product Team  
**Tr·∫°ng th√°i**: S·∫µn s√†ng ƒë·ªÉ review

**B∆∞·ªõc ti·∫øp theo**:
1. ƒê√°nh gi√° v·ªõi stakeholder
2. ƒê√°nh gi√° ƒë·ªôi t√†i ch√≠nh
3. ƒê√°nh gi√° tu√¢n th·ªß (AML/KYC)
4. L·∫≠p k·∫ø ho·∫°ch t√≠ch h·ª£p c·ªïng thanh to√°n